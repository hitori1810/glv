/*********************************************************************************
 * By installing or using this file, you are confirming on behalf of the entity
 * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
 * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
 * http://www.sugarcrm.com/master-subscription-agreement
 *
 * If Company is not bound by the MSA, then by installing or using this file
 * you are agreeing unconditionally that Company will be bound by the MSA and
 * certifying that you have authority to bind Company accordingly.
 *
 * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
 ********************************************************************************/
/*;
 * SugarCRM Javascript API
 *///create the SUGAR namespace if one does not exist already
var SUGAR=SUGAR||{};SUGAR.Api=function(){function o(e){function v(e){e?(h=e.access_token,p=e.refresh_token,a&&(a.set("AuthAccessToken",h),a.set("AuthRefreshToken",p))):(h=null,p=null,a&&(a.cut("AuthAccessToken"),a.cut("AuthRefreshToken")))}var o,u,a,f,l,c,h=null,p=null,d=[];a=e&&e.keyValueStore,o=e&&e.serverUrl||"/rest/v10",u=e&&e.platform||"",f=e&&e.clientID||"sugar",l=(e&&e.timeout||30)*1e3;if(a){if(!$.isFunction(a.set)||!$.isFunction(a.get)||!$.isFunction(a.cut))throw new Error("Failed to initialize Sugar API: key/value store provider is invalid");h=a.get("AuthAccessToken"),p=a.get("AuthRefreshToken")}return c=!1,e&&e.reset&&(r=0),{clientID:f,serverUrl:o,timeout:l,debug:!1,call:function(e,n,r,o,u){var a,f,l,p=t[e],v=this,m={type:p,dataType:"json",headers:{},timeout:this.timeout};u=u||{},o=o||{},u.url||(m.url=n),m.error=function(e,t,n){var r=new i(l,t,n),s=function(){if(d.length==0||v.refreshingToken(l.params.url))o.error&&o.error(r);else for(var e=0;e<d.length;++e)d[e]._oerror&&d[e]._oerror(r);v.setRefreshingToken(!1)},u,a=!0;v.needRefreshAuthToken(l.params.url,r.code)?(d.push(l),v.setRefreshingToken(!0),v.login(null,{refresh:!0},{complete:function(){if(a)while(u=d.shift())u._ocomplete&&u._ocomplete.apply(this,arguments)},success:function(){a=!1,v.setRefreshingToken(!1);while(u=d.shift())u.execute(h)},error:s})):v.needQueue(l.params.url)?d.push(l):s()},o.success&&(m.success=o.success),m.complete=function(){!c&&o.complete&&o.complete.apply(this,arguments)},r&&(e=="create"||e=="update")&&(m.contentType="application/json",m.data=JSON.stringify(r)),m.type!=="GET"&&(m.processData=!1);if(SUGAR.demoRestServer&&SUGAR.restDemoData)for(a=0;a<SUGAR.restDemoData.length;a++)SUGAR.restDemoData[a].route.test(n)&&(console.log("===Matched demo server route starting demo server==="),console.log("====== url ======"),console.log(n),console.log("====== ds route ======"),console.log(SUGAR.restDemoData[a].route),f=SUGAR.demoRestServer());l=new s(_.extend(m,u),this.debug),l._oerror=o.error,l._ocomplete=o.complete,l.execute(this.isLoginRequest(n)?null:h);if(SUGAR.demoRestServer&&SUGAR.restDemoData)for(a=0;a<SUGAR.restDemoData.length;a++)SUGAR.restDemoData[a].route.test(n)&&(console.log("===Demo Server Responding and Restoring==="),f.respond(),f.restore());return l},buildURL:function(e,t,r,i){i=i||{};var s=[],o;return s.push(this.serverUrl),e&&s.push(e),t!="create"&&r&&r.id&&s.push(r.id),r&&r.link&&t!="file"&&s.push("link"),t&&$.inArray(t,n)===-1&&s.push(t),r&&r.relatedId&&s.push(r.relatedId),r&&t=="file"&&r.field&&s.push(r.field),o=s.join("/"),i=$.param(i),i.length>0&&(o+="?"+i),o},buildFileURL:function(e,t){var n={};return t=t||{},e.field&&t.htmlJsonFormat!==!1&&(n.format="sugar-html-json"),t.deleteIfFails===!0&&(n.delete_if_fails=!0),t.passOAuthToken!==!1&&(n.oauth_token=h),this.buildURL(e.module,"file",e,n)},getOAuthToken:function(){return h},getMetadata:function(e,t,n,r,i){i=i||{};var s=i.params||{},o,a;return t&&(s.type_filter=t.join(",")),n&&(s.module_filter=n.join(",")),u&&(s.platform=u),s._hash=e,o="read",i&&i.getPublic&&(o="public"),a=this.buildURL("metadata",o,null,s),this.call(o,a,null,r)},records:function(e,t,n,r,i){var s=this.buildURL(t,e,n,r);return this.call(e,s,n,i)},relationships:function(e,t,n,r,i){var s=this.buildURL(t,n.link,n,r);return this.call(e,s,n.related,i)},favorite:function(e,t,n,r){var i=n?"favorite":"unfavorite",s=this.buildURL(e,i,{id:t});return this.call("update",s,null,r)},file:function(e,t,n,r,i){var s={files:n,processData:!1};if(!i||i.iframe!==!1)s.iframe=!0;if(!i||i.deleteIfFails!==!1)i=i||{},i.deleteIfFails=!0;return this.call(e,this.buildFileURL(t,i),null,r,s)},search:function(e,t){var n=this.buildURL(null,"search",null,e);return this.call("read",n,null,t)},login:function(e,t,n){var r,i,s,o,a;return e=e||{},n=n||{},i=function(e){v(e),n.success&&n.success(e)},s=function(e){v(),n.error&&n.error(e)},t&&t.refresh?r={grant_type:"refresh_token",client_id:this.clientID,client_secret:"",refresh_token:p,platform:u?u:"base"}:(r={grant_type:"password",username:e.username,password:e.password,client_id:this.clientID,platform:u?u:"base",client_secret:""},r.client_info=t),o="create",a=this.buildURL("oauth2","token",r),this.call(o,a,r,{success:i,error:s,complete:n.complete})},me:function(e,t,n,r){var i=this.buildURL("me",e,t,n);return this.call(e,i,t,r)},css:function(e,t,n){var r={platform:e,themeName:t},i=this.buildURL("css","read",{},r);return this.call("read",i,{},n)},logout:function(e){e=e||{};var t={token:h},n=this.buildURL("oauth2","logout",t),r=e.complete;return e.complete=function(){v(),r&&r()},this.call("create",n,t,e)},signup:function(e,t,n){var r=e;r.client_info=t;var i="create",s=this.buildURL("Leads","register",r);return this.call(i,s,r,n)},verifyPassword:function(e,t){var n={password_to_verify:e},r="create",i=this.buildURL("me/password",r);return this.call(r,i,n,t)},updatePassword:function(e,t,n){var r={new_password:t,old_password:e},i="update",s=this.buildURL("me/password",i);return this.call(i,s,r,n)},info:function(e){var t=this.buildURL("ServerInfo");return this.call("read",t,null,e)},isAuthenticated:function(){return typeof h=="string"&&h.length>0},needRefreshAuthToken:function(e,t){return!c&&typeof p=="string"&&p.length>0&&!this.isAuthRequest(e)&&t==="invalid_grant"},needQueue:function(e){return c&&!this.isAuthRequest(e)},isAuthRequest:function(e){return/\/oauth2\//.test(e)},isLoginRequest:function(e){return/\/oauth2\/token/.test(e)},refreshingToken:function(e){return c&&this.isAuthRequest(e)},setRefreshingToken:function(e){c=e}}}var e,t={read:"GET",update:"PUT",create:"POST","delete":"DELETE"},n=["read","update","create","delete"],r=0,i=function(e,t,n){e=e||{},e.xhr=e.xhr||{},this.request=e,this.status=e.xhr.status,this.responseText=e.xhr.responseText,this.textStatus=t,this.errorThrown=n;if(typeof this.responseText=="string"&&this.responseText.length>0)try{var r=this.request.xhr.getResponseHeader("Content-Type");if(r&&r.indexOf("application/json")===0){var i=JSON.parse(this.responseText);this.code=i.error,this.message=i.error_message}}catch(s){}};_.extend(i.prototype,{toString:function(){return"HTTP error: "+this.status+"\ntype: "+this.textStatus+"\nerror: "+this.errorThrown+"\nresponse: "+this.responseText}});var s=function(e,t){this.params=e,this.debug=t,this.numExecuted=0};return _.extend(s.prototype,{execute:function(e){e&&(this.params.headers=this.params.headers||{},this.params.headers["OAuth-Token"]=e);if(this.debug){console.log("====== Ajax Request Begin ======"),console.log(this.params.type+" "+this.params.url);var t=this.params.data?JSON.parse(this.params.data):null;t&&t.password&&(t.password="***"),console.log("Payload: ",this.params.data?t:"N/A");var n=$.extend({},this.params);delete n.data,console.log("params: ",n),console.log("====== Request End ======")}if(this.numExecuted==0){var i=this.params.complete;this.params.complete=function(e,t){r--,_.isFunction(i)&&i(e,t)}}this.xhr=$.ajax(this.params),r++,this.numExecuted++}}),{getInstance:function(t){return e||this.createInstance(t)},createInstance:function(t){return e=new o(t),e},getCallsInProgressCount:function(){return r},HttpError:i,HttpRequest:s}}();var SUGAR=SUGAR||{};SUGAR.App=function(){function r(e){var t=_.uniqueId("SugarApp_");return e=e||{},_.extend({appId:t,$rootEl:n(e.el||"body"),$contentEl:n(e.contentEl||"#content"),api:null,additionalComponents:{}},this,Backbone.Events)}var e,t={},n=function(e){return e instanceof $?e:$(e)};return{init:function(t){e=e||_.extend(this,new r(t)),e.events.register("app:init",this),e.events.register("app:start",this),e.events.register("app:sync",this),e.events.register("app:sync:complete",this),e.events.register("app:sync:error",this),e.events.register("app:login:success",this),e.events.register("app:logout",this),e.events.register("app:view:change",this),e.cache&&e.cache.init(this);var n=e.utils.capitalize(e.config?e.config.appId:"")+"Controller",i=this[n]||this.Controller;return this.controller=new i,e.api=SUGAR.Api.getInstance({serverUrl:e.config.serverUrl,platform:e.config.platform,timeout:e.config.serverTimeout,keyValueStore:e[e.config.authStore||"cache"],clientID:e.config.clientID}),this._init(t),e},_init:function(t){var n=this,r=function(r){if(!e)return;if(r){n.trigger("app:sync:error",r);return}n._initModules(),n._loadConfig(),t.silent||e.trigger("app:init",n),t.callback&&_.isFunction(t.callback)&&t.callback(e)},i=function(t){e.config.loadCss?e.loadCss(t):t()};if(e.config.syncConfig!==!1){var s={getPublic:!0};i(function(){e.metadata.sync(r,s)})}else i(function(){r()});return e},_initModules:function(){_.each(t,function(e){_.isFunction(e.init)&&e.init(this)},this)},_loadConfig:function(){e.config=e.config||{},e.config=_.extend(e.config,e.metadata.getConfig())},loadCss:function(t){e.api.css(e.config.platform,e.config.themeName,{success:function(n){e.config.loadCss==="url"?$("<link>").attr({rel:"stylesheet",type:"text/css",href:e.config.siteUrl+"/"+n.url+"?t="+(new Date).getTime()}).appendTo("head"):$("<style>").html(n.text).appendTo("head"),_.isFunction(t)&&t()}})},start:function(){e.events.registerAjaxEvents(),e.trigger("app:start",this),e.router.start()},destroy:function(){Backbone.history&&Backbone.history.stop(),e=null},augment:function(n,r,i){this[n]=r,t[n]=r,i&&r.init&&_.isFunction(r.init)&&r.init.call(e)},sync:function(t){var n=this;t=t||{};if(t.getPublic)return n.syncPublic(t);async.waterfall([function(r){n.isSynced=!1,n.trigger("app:sync");var i=!t.noUserUpdate&&(t.language||e.lang.hasChanged);if(i){var s=t.language||e.lang.getLanguage();n.user.updateLanguage(s,r)}else r()},function(e){n.user.load(e)},function(e){n.metadata.sync(e,t)},function(e){n.data.declareModels(),e()}],function(e){e?n.trigger("app:sync:error",e):(n.isSynced=!0,n.trigger("app:sync:complete")),_.isFunction(t.callback)&&t.callback(e)})},syncPublic:function(e){e=e||{},e.getPublic=!0,this.metadata.sync(e.callback,e)},navigate:function(t,n,r,i){var s,o,u;t=t||e.controller.context,n=n||t.get("model"),o=n.id,u=t.get("module")||n.module,s=this.router.buildRoute(u,o,r,i),this.router.navigate(s,{trigger:!0})},login:function(t,n,r){r=r||{},e.api.login(t,n,{success:function(t){e.trigger("app:login:success",t),r.success&&r.success(t)},error:function(t){e.error.handleHttpError(t),r.error&&r.error(t)},complete:r.complete})},logout:function(t,n){var r,i;return t=t||{},r=t.complete,i=t.error,t.complete=function(t){e.trigger("app:logout",n),r&&r(t)},t.error=function(t){e.error.handleHttpError(t),i&&i(t)},e.api.logout(t)},isServerCompatible:function(e){var t=this.config.supportedServerFlavors,n=this.config.minServerVersion,r,i,s;return _.isEmpty(t)&&!n?!0:(r=!!(_.isEmpty(t)||e&&_.contains(t,e.flavor)),i=!!(!n||e&&this.utils.versionCompare(e.version,n,">=")),r&&i?!0:(i?s={code:"server_flavor_incompatible",label:"ERR_SERVER_FLAVOR_INCOMPATIBLE"}:s={code:"server_version_incompatible",label:"ERR_SERVER_VERSION_INCOMPATIBLE"},s.server_info=e,s))},modules:t}}(),function(app){var _doWhenStack=[],_doWhenLocked=!1,_doWhenInterval=!1,_doWhenretryCount=0;_startDoWhenInterval=function(){_doWhenInterval||(_doWhenInterval=window.setInterval(app.utils._doWhenCheck,50))},app.augment("utils",{capitalize:function(e){return e?e.charAt(0).toUpperCase()+(e.length>1?e.substr(1):""):""},capitalizeHyphenated:function(e){return this._classify(e,"-")},classify:function(e){return this._classify(e,"_")},_classify:function(e,t){var n=this,r="";t=t||"_";if(!e||e.lastIndexOf(t)===-1)r=n.capitalize(e);else{var i=e.split(t);_.each(i,function(e){r+=n.capitalize(e)})}return r},formatNumber:function(e,t,n,r,i){t=t||n;var s=e;if(_.isString(e)){e=parseFloat(e,10);if(_.isNaN(e))return s}return _.isNumber(e)?(e=parseFloat(e.toFixed(t),10).toFixed(n).toString(),_.isString(r)&&_.isString(i)?this.addNumberSeperators(e,r,i):e):(!_.isNull(e)&&!_.isUndefined(e)&&app.logger.warn("formatNumber: invalid variable type ("+typeof s+")"),s)},formatNumberLocale:function(e){return this.formatNumber(e,app.user.getPreference("decimal_precision")||2,app.user.getPreference("decimal_precision")||2,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".")},addNumberSeperators:function(e,t,n){var r=e.split("."),i=/(\d+)(\d{3})/;while(t!==""&&i.test(r[0]))r[0]=r[0].toString().replace(i,"$1"+t+"$2");return r[0]+(r.length>1&&r[1]!==""?n+r[1]:"")},unformatNumberString:function(e,t,n,r){r=r||!1;if(typeof t=="undefined"||typeof n=="undefined")return e;if(t!==""){var i=new RegExp("\\"+t,"g");e=e.replace(i,"")}return e=e.replace(n,"."),e.length>0&&r&&(e=parseFloat(e)),e},unformatNumberStringLocale:function(e,t){return this.unformatNumberString(e,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".",t)},formatString:function(e,t){for(var n in t)e=e.replace("{"+n+"}",t[n]);return e},regexEscape:function regexEscape(e){if(typeof regexEscape.specialRegExp=="undefined"){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\","-",",","^","$","#"];regexEscape.specialRegExp=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(regexEscape.specialRegExp,"\\$1")},cookie:{setCookie:function(t,n,r){var i=new Date,s;i.setDate(i.getDate()+r),s=escape(n)+(r===null?"":"; expires="+i.toUTCString()),document.cookie=t+"="+s},getCookie:function(e){var t,n,r,i=document.cookie.split(";");for(t=0;t<i.length;t++){n=i[t].substr(0,i[t].indexOf("=")),r=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,"");if(n===e)return unescape(r)}}},isValidEmailAddress:function(e){return/^\s*[\w.%+\-]+@([A-Z0-9-]+\.)*[A-Z0-9-]+\.[A-Z]{2,}\s*$/i.test(e)||/^.*<[A-Z0-9._%+\-]+?@([A-Z0-9-]+\.)*[A-Z0-9-]+\.[A-Z]{2,}>\s*$/i.test(e)},doWhen:function(e,t,n,r){_doWhenStack.push({check:e,fn:t,obj:n,overrideContext:r}),_doWhenretryCount=50,_startDoWhenInterval()},_doWhenCheck:function(){if(_doWhenStack.length===0){_doWhenretryCount=0,_doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);return}if(_doWhenLocked)return;_doWhenLocked=!0;var tryAgain=$.isReady;tryAgain||(tryAgain=_doWhenretryCount>0&&_doWhenStack.length>0);var notAvail=[],executeItem=function(e,t){t.overrideContext&&(t.overrideContext===!0?e=t.obj:e=t.overrideContext),t.fn&&t.fn.call(e,t.obj)},i,len,item,test;for(i=0,len=_doWhenStack.length;i<len;i+=1)item=_doWhenStack[i],item&&(test=item.check,typeof test=="string"&&eval(test)||typeof test=="function"&&test()?(executeItem(this,item),_doWhenStack[i]=null):notAvail.push(item));_doWhenretryCount--;if(tryAgain){for(i=_doWhenStack.length-1;i>-1;i--)item=_doWhenStack[i],(!item||!item.check)&&_doWhenStack.splice(i,1);_startDoWhenInterval()}else _doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);_doWhenLocked=!1},versionCompare:function(e,t,n){return version_compare(e,t,n)}})}(SUGAR.App),function(e){e.augment("date",function(){var e={};return{parse:function(e,t){var n=new Date("Jan 1, 1970 00:00:00"),r="",i,s,o,u,a,f;if(e instanceof Date)return e;t||(t=this.guessFormat(e));if(t===!1)return/^\d+$/.test(e)?new Date(e):!1;i=$.trim(e),t=$.trim(t)+" ";for(s=0;s<t.length;s++){o=t.charAt(s);if(o===":"||o==="/"||o==="-"||o==="."||o===" "||o==="a"||o==="A"){u=i.indexOf(o),u===-1&&(u=i.length),a=i.substring(0,u),i=i.substring(u+1);switch(r){case"m":if(!(a>0&&a<13))return!1;n.setMonth(a-1);break;case"d":if(!(a>0&&a<32))return!1;n.setDate(a);break;case"Y":if(a>0==0)return!1;n.setYear(a);break;case"h":f=t.substring(t.length-4),(f.toLowerCase()==="i a "||f.toLowerCase()===o+"ia ")&&i.substring(i.length-2).toLowerCase()==="pm"&&(a*=1,a<12&&(a+=12)),n.setHours(a);break;case"H":n.setHours(a);break;case"i":a=a.substring(0,2),n.setMinutes(a);break;case"s":n.setSeconds(a)}r=""}else r=o}return n},guessFormat:function(e){if(typeof e!="string")return!1;var t="",n,r,i,s,o,u,a,f;e.indexOf(" ")!==-1&&(t=e.substring(e.indexOf(" ")+1,e.length),e=e.substring(0,e.indexOf(" "))),n="/";if(e.indexOf("/")===-1)if(e.indexOf("-")!==-1)n="-";else{if(e.indexOf(".")===-1)return!1;n="."}r=e.split(n),i="";if(r[0].length===4)i="Y"+n+"m"+n+"d";else{if(r[2].length!==4)return!1;i="m"+n+"d"+n+"Y"}return s="",o=[],t!==""&&(o.push("i"),u=":",t.indexOf(".")===2&&(u="."),t.split(u).length===3&&o.push("s"),a="",f=t.substring(t.length-2,t.length),f.toLowerCase()==="am"||f.toLowerCase()==="pm"?(o.unshift("h"),f.toLowerCase()===f?a="lower":a="upper"):o.unshift("H"),s=o.join(u),t.indexOf(" ")!==-1&&(s+=" "),a&&a==="upper"?s+="A":a&&a==="lower"&&(s+="a"),i=i+" "+s),i},parseFormat:function(t){if(!(t in e)){var n={},r,i;for(r=0;r<t.length;r++){i=t.charAt(r);switch(i){case"m":case"n":n.month=i;break;case"d":case"j":n.day=i;break;case"Y":n.year=i;break;case"H":case"h":case"g":n.hours=i;break;case"i":n.minutes=i;break;case"s":n.seconds=i;break;case"A":case"a":n.amPm=i;break;default:}}e[t]=n}return e[t]},format:function(e,t){if(!_.isDate(e))return"";var n="",r,i,s,o,u,a;for(r=0;r<t.length;r++){i=t.charAt(r);switch(i){case"\\":n+=t.charAt(r+1),r++;break;case"m":case"n":u=e.getMonth()+1,n+=u<10&&i==="m"?"0"+u:u;break;case"d":case"j":s=e.getDate(),n+=s<10&&i==="d"?"0"+s:s;break;case"Y":n+=e.getFullYear();break;case"H":case"h":case"g":o=e.getHours();if(i==="h"||i==="g")o=o>12?o-12:o,o=o===0?12:o;n+=o<10&&i!=="g"?"0"+o:o;break;case"i":u=e.getMinutes(),n+=u<10?"0"+u:u;break;case"s":a=e.getSeconds(),n+=a<10?"0"+a:a;break;case"a":case"A":e.getHours()<12?n+=i==="a"?"am":"AM":n+=i==="a"?"pm":"PM";break;default:n+=i}}return n},roundTime:function(e){if(!e.getMinutes)return 0;var t=e.getMinutes();return t<1?t=0:t<16?t=15:t<31?t=30:t<46?t=45:(t=0,e.setHours(e.getHours()+1)),e.setMinutes(t),e},UTCtoLocalTime:function(e){return e instanceof Date?new Date(this.toUTC(e)):e},UTCtoTimezone:function(e,t){return e instanceof Date&&undefined!==t&&null!==t?(t=parseFloat(t)*60*60*1e3,t-=e.getTimezoneOffset()*60*1e3*-1,new Date(this.toUTC(e)+t)):e},toUTC:function(e){if(e instanceof Date){var t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),i=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),u=e.getMilliseconds();return Date.UTC(t,n,r,i,s,o,u)}return e},getRelativeTimeLabel:function(e){var t=new Date,n=t-e,r=1e3,i=r*60,s=i*60,o=s*24,u={str:"",value:undefined};return isNaN(n)||n<0?u:n<r*2?(u.str="LBL_TIME_AGO_NOW",u):n<i?(u.str="LBL_TIME_AGO_SECONDS",u.value=Math.floor(n/r),u):n<i*2?(u.str="LBL_TIME_AGO_MINUTE",u):n<s?(u.str="LBL_TIME_AGO_MINUTES",u.value=Math.floor(n/i),u):n<s*2?(u.str="LBL_TIME_AGO_HOUR",u):n<o?(u.str="LBL_TIME_AGO_HOURS",u.value=Math.floor(n/s),u):n>o&&n<o*2?(u.str="LBL_TIME_AGO_DAY",u):n<o*365?(u.str="LBL_TIME_AGO_DAYS",u.value=Math.floor(n/o),u):(u.str="LBL_TIME_AGO_YEAR",u)},parseDisplayDefault:function(e,t){var n,r,i,s,o,u,a,f,l=t?t:new Date,c,h,p,d;return e?(u=function(e,t){var n=e.getDate();return e.setMonth(e.getMonth()+t),e.getDate()<n&&(e.setDate(1),e.setDate(e.getDate()-1)),e},a=function(e){var t,n,r,i;t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],n=l.getDay(),e=e.toLowerCase();for(var r=7;r--;)if(e===t[r]){e=r<=n?r+7:r;break}return i=e-n,i},n={day:function(e){return new Date(l.setDate(l.getDate()+e))},week:function(e){return new Date(l.setDate(l.getDate()+e*7))},month:function(e){return u(l,e)},year:function(e){return u(l,e*12)},now:function(){return l},"next monday":function(){return new Date(l.setDate(l.getDate()+a("monday")))},"next friday":function(){return new Date(l.setDate(l.getDate()+a("friday")))},"first of next month":function(){l.setDate(1);var e=l.setMonth(l.getMonth()+1);return new Date(e)}},e&&e.indexOf("&")>=0?(i=e.split("&"),s=i[0],o=i[1]):s=e,s.match(/\b(now|day|week|month|year)/g)?(s.indexOf("now")===0?h="now":s.indexOf("first day of next month")!==-1?h="firstnextmonth":(p=s.split(" "),c=p[0],h=p[1]),h.match("now")?r=n.now():h.match("firstnextmonth")?r=n["first of next month"]():h.match("days?")?r=n.day(parseInt(c,10)):h.match("weeks?")?r=n.week(parseInt(c,10)):h.match("months?")?r=n.month(parseInt(c,10)):h.match("years?")?r=n.year(parseInt(c,10)):r=n[s]()):r=n[s](),f=function(e){var t,n,r;t=/^(\d{2}).(\d{2}).?([ap]m)?$/.exec(o),t&&t.length>2&&(n=t[1],n&&(t[3]==="pm"?n<12&&(n=parseInt(n,10)+12):n==="12"&&(n="0"),e.setHours(parseInt(n,10))),r=t[2],r&&e.setMinutes(parseInt(r,10)))}(r),r):e},toDatepickerFormat:function(e){if(_.isUndefined(e)||!e)return"";var t,n={y:"yy",Y:"yyyy",m:"mm",d:"dd"};return t=e.replace(/[yYmd]/g,function(e){return n[e]}),t},stripIsoTimeDelimterAndTZ:function(e){if(!_.isUndefined(e)&&e)return e.replace("T"," ").substr(0,19)},isIso:function(e){var t,n;t=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/);if(t)return!0;if(e.match(/[T\+Z ]/g)){n=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])/);if(n)return!0}return!1}}}(),!1)}(SUGAR.App),function(e){e.augment("file",function(){return{checkFileFieldsAndProcessUpload:function(t,n,r){var i,s,o,u,a,f,l,c;n=n||{},r=r||{},o=_.filter($(":file"),function(e){var t=$(e);return t.val()&&t.attr("name")&&t.attr("name")!==""?t.val()!=="":!1}),u=o.length,a={},l=function(t){u--,_.extend(a,t),u===0&&(e.alert.dismiss("upload"),n.success&&n.success(a))},c=function(n){var i={};r.deleteIfFails!==!1&&t.unset("id",{silent:!0}),u=0,e.alert.dismiss("upload"),i[n.responseText]={},t.trigger("error:validation:"+this.field,i),t.trigger("error:validation")};if(u>0){e.alert.show("upload",{level:"process",title:"LBL_UPLOADING",autoclose:!1});for(i in o)s=$(o[i]),f=s.attr("name"),t.uploadFile(f,s,{field:f,success:l,error:c},r)}else n.success&&n.success(a)}}}(),!1)}(SUGAR.App),function(e){e.augment("math",{_math:function(t,n,r,i,s){i=_.isFinite(i)&&i>=0?parseInt(i):e.user.getPreference("decimal_precision"),s=s||!1;var o,u=Math.pow(10,i),a=parseFloat(n)*u,f=_.isUndefined(r)?undefined:parseFloat(r)*u;switch(t){case"round":o=Math.round(a)/u;break;case"add":o=(a+f)/u;break;case"sub":o=(a-f)/u;break;case"mul":o=this.round(a*f/u/u,i,s);break;case"div":o=this.round(a/f,i,s);break;default:return n}return s?o.toFixed(i):o},round:function(e,t,n){return this._math("round",e,null,t,n)},add:function(e,t,n,r){return this._math("add",e,t,n,r)},sub:function(e,t,n,r){return this._math("sub",e,t,n,r)},mul:function(e,t,n,r){return this._math("mul",e,t,n,r)},div:function(e,t,n,r){return this._math("div",e,t,n,r)}},!1)}(SUGAR.App),function(e){e.augment("currency",{getCurrencySymbol:function(t){var n=e.metadata.getCurrency(t);return n?n.symbol:""},formatAmount:function(t,n,r,i,s,o){var u;return n=n||"-99",o=o||"",r=r||2,s=s||".",i=_.isUndefined(i)?",":i,u=this.getCurrencySymbol(n)||"$",t=e.utils.formatNumber(t,r,r,i,s),u+o+t},formatAmountLocale:function(t,n,r){var i=e.user.getPreference("decimal_precision"),s=e.user.getPreference("decimal_separator"),o=e.user.getPreference("number_grouping_separator");return this.formatAmount(t,n,i,o,s,r)},unformatAmount:function(t,n,r,i){return i=i||!1,t=t.toString().replace(/^[^\d\.\,]+/,""),e.utils.unformatNumberString(t,n,r,i)},unformatAmountLocale:function(t,n){var r,i;return r=e.user.getPreference("decimal_separator")||".",i=e.user.getPreference("number_grouping_separator")||",",this.unformatAmount(t,i,r,n)},convertAmount:function(t,n,r){var i,s;return n==r?e.math.round(t):(i=e.metadata.getCurrency(n),s=e.metadata.getCurrency(r),this.convertWithRate(t,i.conversion_rate,s.conversion_rate))},convertToBase:function(e,t){return this.convertAmount(e,t,"-99")},convertFromBase:function(e,t){return this.convertAmount(e,"-99",t)},convertWithRate:function(t,n,r){return n=n||1,r=r||1,e.math.mul(e.math.div(t,n),r)}},!1)}(SUGAR.App),function(e){var t="",n=function(e){return t+e},r={store:stash,init:function(){t=e.config.env+":"+e.config.appId+":"},has:function(e){if(this.store===stash)return window.localStorage.getItem(n(e))!==null;this.store.has(n(e))},get:function(e){return this.store.get(n(e))},set:function(e,t){this.store.set(n(e),t)},add:function(e,t){this.store.add(n(e),t)},cut:function(e){this.store.has(n(e))&&this.store.cut(n(e))},cutAll:function(e){if(e===!0)return this.store.cutAll();_.each(this.store.getAll(),function(e,n){n.indexOf(t)===0&&this.store.cut(n)},this)}};e.augment("cache",r)}(SUGAR.App),function(e){e.augment("events",_.extend({register:function(e,t){t.on(e,function(){var t=[].slice.call(arguments,0);t.unshift(e),this.trigger.apply(this,t)},this)},unregister:function(e,t){e.off(t)},registerAjaxEvents:function(){var e=this;$(document).off("ajaxStop"),$(document).off("ajaxStart"),$(document).on("ajaxStart",function(t){e.trigger("ajaxStart",t)}),$(document).on("ajaxStop",function(t){e.trigger("ajaxStop",t)})}},Backbone.Events))}(SUGAR.App),function(e){var t={init:function(){this.initialize()},initialize:function(e){e=e||{},this.remoteLogging=e.remoteLogging||!1,this.statusCodes=e.statusCodes?_.extend(this.statusCodes,e.statusCodes):this.statusCodes,e.disableOnError||this.enableOnError()},_callCustomHandler:function(e,t){t?t.call(this,e):this.handleStatusCodesFallback(e)},_handleFineGrainedError:function(t,n){var r="handle"+e.utils.classify(t.code)+"Error";(this[r]||n||this.handleStatusCodesFallback).call(this,t)},statusCodes:{0:function(e){e.textStatus==="timeout"?this._callCustomHandler(e,this.handleTimeoutError):this.handleStatusCodesFallback(e)},400:function(e){this._handleFineGrainedError(e)},401:function(e){this._handleFineGrainedError(e,this.handleUnauthorizedError)},403:function(e){this._callCustomHandler(e,this.handleForbiddenError)},404:function(e){this._callCustomHandler(e,this.handleNotFoundError)},405:function(e){this._callCustomHandler(e,this.handleMethodNotAllowedError)},412:function(e){this._callCustomHandler(e,this.handlePreconditionFailureError)},422:function(e,t){this.handleValidationError(t,e.responseText)},500:function(e){this._callCustomHandler(e,this.handleServerError)}},remoteLogging:!1,errorName2Keys:{maxValue:"ERROR_MAXVALUE",minValue:"ERROR_MINVALUE",maxLength:"ERROR_MAX_FIELD_LENGTH",minLength:"ERROR_MIN_FIELD_LENGTH",datetime:"ERROR_DATETIME",required:"ERROR_FIELD_REQUIRED",email:"ERROR_EMAIL",number:"ERROR_NUMBER"},getErrorString:function(t,n){var r=n.module||"";return e.lang.get(this.errorName2Keys[t]||t,r,n)},handleValidationError:function(t,n){e.alert.dismissAll(),_.each(n,function(t,n){var r="";_.isObject(t)?_.each(t,function(e,t){r+="(Message) "+this.getErrorString(t,e)+"\n"},this):r=t,e.logger.debug("validation failed for field `"+n+"`:\n"+r)},this)},handleHttpError:function(e,t){this.statusCodes[e.status]?this.statusCodes[e.status].call(this,e,t):this.handleStatusCodesFallback(e)},handleUnhandledError:function(t,n,r){e.logger.fatal(t+" at "+n+" on line "+r)},handleStatusCodesFallback:function(t){e.logger.error(t.toString())},handleRenderError:function(t,n,r){var i="render_error_"+t.module+"_"+t.name,s="error",o,u;switch(n){case"_renderHtml":o=e.lang.getAppString("ERR_RENDER_FAILED_TITLE"),u=[e.lang.getAppString("ERR_RENDER_FAILED_MSG"),e.lang.getAppString("ERR_CONTACT_TECH_SUPPORT")];break;case"_renderField":o=e.lang.getAppString("ERR_RENDER_FIELD_FAILED_TITLE"),u=[e.utils.formatString(e.lang.getAppString("ERR_RENDER_FIELD_FAILED_MSG"),[r.name]),e.lang.getAppString("ERR_CONTACT_TECH_SUPPORT")];break;case"view_render_denied":o=e.lang.getAppString("ERR_NO_VIEW_ACCESS_TITLE"),s="warning",u=[e.utils.formatString(e.lang.getAppString("ERR_NO_VIEW_ACCESS_MSG"),[t.module])];break;case"layout_render":o=e.lang.getAppString("ERR_LAYOUT_RENDER_TITLE"),u=[e.lang.getAppString("ERR_LAYOUT_RENDER_MSG")];break;default:o=e.lang.getAppString("ERR_GENERIC_TITLE"),u=[e.lang.getAppString("ERR_INTERNAL_ERR_MSG"),e.lang.getAppString("ERR_CONTACT_TECH_SUPPORT")],e.logger.error("handleRenderError called for render error caught in "+n+", but we have no corresponding handler!")}e.alert.show(i,{level:s,title:o,messages:u,autoClose:!0})},enableOnError:function(e,t){var n,r=this;return this.overloaded?!1:(n=window.onerror,window.onerror=function(i,s,o){e?e.call(t):r.handleUnhandledError(i,s,o),n&&n()},this.overloaded=!0,!0)}};e.augment("error",t,!1)}(SUGAR.App),function(app){var _header="(function() {\n  var template = Handlebars.template, templates = Handlebars.templates = Handlebars.templates || {};\n",_footer="})();",_templates={},_templateManager;_templateManager={init:function(){_templates=app.config.cacheMeta?app.cache.get("templates")||{}:{};var src="";_.each(_templates,function(e){src+=e});try{eval(_header+src+_footer)}catch(e){app.logger.error("Failed to eval templates retrieved from local storage:\n"+e)}},_compile:function(e,t,n){return Handlebars.templates=Handlebars.templates||{},_templates[e[0]]=Handlebars.templates[e[0]]=n||!e[1]?this.compile(e[0],t):e[1],_templates[e[0]]},compile:function(key,src){try{_templates[key]="templates['"+key+"'] = template("+Handlebars.precompile(src)+");\n",eval(_header+_templates[key]+_footer)}catch(e){app.logger.error("Failed to compile or eval template "+key+".\n"+e)}return this.get(key)||this.empty},get:function(e){return Handlebars.templates?Handlebars.templates[e]:null},_getView:function(e,t){var n=e+(t?"."+t:"");return[n,this.get(n)]},getView:function(e,t){return this._getView(e,t)[1]},_getField:function(e,t,n,r,i){var s,o="f."+e+".",u=o+(n?n+".":"")+t;return n+=".",s=this.get(o+n+t)||this.get(o+t),!s&&!i&&(s=this.get(o+n+r)||this.get(o+r),s||(s=this.get("f.base."+t)||this.get("f.base."+r))),[u,s]},getField:function(e,t,n,r){return this._getField(e,t,n,r)[1]},_getLayout:function(e,t){var n="l."+(t?t+".":"")+e;return[n,this.get(n)]},getLayout:function(e,t){return this._getLayout(e,t)[1]},setView:function(e,t,n,r){return this._compile(this._getView(e,t),n,r)},setField:function(e,t,n,r,i){return this._compile(this._getField(e,t,n,null,!0),r,i)},setLayout:function(e,t,n,r){return this._compile(this._getLayout(e,t),n,r)},set:function(e,t){e.views&&_.each(e.views,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){this.setView(n,null,e,t)},this)},this),e.fields&&_.each(e.fields,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){this.setField(n,r,null,e,t)},this)},this),e.layouts&&_.each(e.layouts,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){this.setLayout(n,null,e,t)},this)},this)},empty:function(){return""}},app.augment("template",_templateManager)}(SUGAR.App),function(e){e.Context=Backbone.Model.extend({initialize:function(e){Backbone.Model.prototype.initialize.call(this,e),this.id=this.cid,this.parent=null,this.children=[],this._dataFetched=!1},clear:function(e){_.each(this.children,function(t){t.clear(e)}),this.children=[],this.parent=null,Backbone.Model.prototype.clear.call(this,e),this.resetLoadFlag(),this.off()},resetLoadFlag:function(){this._dataFetched=!1,_.each(this.children,function(e){e.resetLoadFlag()})},isCreate:function(){return this.get("create")===!0},getChildContext:function(t){var n,r=t.link||t.module;r&&(n=_.find(this.children,function(e){return e.get("link")==r||e.get("module")==r})),n||(n=e.context.getContext(t),this.children.push(n),n.parent=this);if(t.link){var i=this.get("model");n.set({parentModel:i,parentModule:i?i.module:null})}return n},prepare:function(e
){if(!e&&(this.get("model")||this.get("collection")))return;var t=this.get("modelId"),n=this.get("create"),r=this.get("link");return this.set(r?this._prepareRelated(r,t,n):this._prepare(t,n)),this},_prepare:function(t,n){var r,i,s=this.get("module"),o=this.get("mixed"),u;return t?(r=e.data.createBean(s,{id:t}),u=[r]):n===!0?(r=e.data.createBean(s),u=[r]):r=e.data.createBean(s),i=o===!0?e.data.createMixedBeanCollection(u):e.data.createBeanCollection(s,u),{collection:i,model:r}},_prepareRelated:function(t,n,r){var i,s,o=this.get("parentModel");return o=o||e.data.createBean(this.get("parentModule"),{id:this.get("parentModelId")}),n?(i=e.data.createRelatedBean(o,n,t),s=e.data.createRelatedCollection(o,t,[i])):r===!0?(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t,[i])):(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t)),this.has("parentModule")||this.set({parentModule:o.module},{silent:!0}),this.has("module")||this.set({module:i.module},{silent:!0}),{parentModel:o,collection:s,model:i}},loadData:function(t){if(this._dataFetched||this.get("create")===!0)return;var n,r=this.get("modelId"),i=this.get("module"),s=e.config.orderByDefaults&&i?e.config.orderByDefaults[i]:null;t=t||{},n=r?this.get("model"):this.get("collection"),s&&n instanceof e.BeanCollection&&!n.orderBy&&(n.orderBy=s),n&&(n instanceof e.Bean||n instanceof e.BeanCollection)?(this.get("link")&&(t.relate=!0),this.get("fields")&&(t.fields=this.get("fields")),this.get("limit")&&(t.limit=this.get("limit")),this.get("module_list")&&(t.module_list=this.get("module_list")),n.fetch(t),this._dataFetched=!0):e.logger.warn("Skipping fetch because model is not Bean, Bean Collection, or it is not defined, module: "+this.get("module"))}}),e.augment("context",{getContext:function(t){return new e.Context(t)}})}(SUGAR.App),function(e){var t=Backbone.View.extend({initialize:function(){this.context=e.context.getContext(),e.events.on("app:sync:complete",function(){_.each(e.additionalComponents,function(e){e&&_.isFunction(e._setLabels)&&e._setLabels(),e.render()}),e.router.start()}),e.events.on("app:login:success",function(){e.sync()})},loadView:function(t){this.layout&&this.layout.dispose(),this.context.clear({silent:!0}),this.context.set(t),this.context.prepare(),this.layout=e.view.createLayout({name:t.layout,module:t.module,context:this.context}),e.$contentEl.html(this.layout.$el),this.layout.render(),e.trigger("app:view:change",t.layout,t),(!t||t&&!t.skipFetch)&&this.layout.loadData()},loadAdditionalComponents:function(t){_.each(e.additionalComponents,function(e){e&&(e.remove(),e.dispose())}),e.additionalComponents={},_.each(t,function(t,n){t.target?(t.layout?e.additionalComponents[n]=e.view.createLayout({context:this.context,name:t.layout,el:this.$(t.target)}):e.additionalComponents[n]=e.view.createView({name:t.view||n,context:this.context,el:this.$(t.target)}),e.additionalComponents[n].render()):e.logger.error("Unable to create Additional Component '"+n+"'; No target specified.")})}});e.augment("Controller",t,!1),e.events.on("app:init",function(e){e.controller.setElement(e.$rootEl)},e.controller).on("app:start",function(e){e.controller.loadAdditionalComponents(e.config.additionalComponents)})}(SUGAR.App),function(e){e.augment("routing",{before:function(t,n){return _.indexOf(e.config.unsecureRoutes,t)>=0?!0:e.api.isAuthenticated()?e.isSynced?!0:(Backbone.history.stop(),e.sync(),!1):(e.router.login(),!1)},after:function(e,t){}});var t=Backbone.Router.extend({routes:{"":"index",logout:"logout","logout/?clear=:clear":"logout",":module":"list",":module/layout/:view":"layout",":module/create":"create",":module/:id/:action":"record",":module/:id":"record"},_routeHandler:function(t){var n=Array.prototype.slice.call(arguments,1),r=t.route;e.routing.before(r,n)&&(t.apply(this,n),e.routing.after(r,n))},route:function(e,t,n){n||(n=this[t]),n.route=t,n=_.wrap(n,this._routeHandler),Backbone.Router.prototype.route.call(this,e,t,n)},goBack:function(){e.logger.debug("Navigating back..."),window.history.back()},go:function(e){window.history.go(e)},start:function(){return e.logger.info("Router Started"),Backbone.history.stop(),Backbone.history.start()},buildRoute:function(e,t,n,r){var i;return e?(i=_.isString(e)?e:e.get("module"),t&&(i+="/"+t),n&&(i+="/"+n)):i=n,i},index:function(){e.logger.debug("Route changed to index"),e.config.defaultModule?this.list(e.config.defaultModule):e.acl.hasAccess("read","Home")&&this.layout("Home","home")},list:function(t){e.logger.debug("Route changed to list of "+t),e.controller.loadView({module:t,layout:"list"})},layout:function(t,n){e.logger.debug("Route changed to layout: "+n+" for "+t),e.controller.loadView({module:t,layout:n})},create:function(t){e.logger.debug("Route changed: create "+t),e.controller.loadView({module:t,create:!0,layout:"edit"})},login:function(){e.logger.debug("Logging in"),e.controller.loadView({module:"Login",layout:"login",create:!0})},logout:function(t){t=t=="1"?!0:!1,e.logger.debug("Logging out: "+t),e.logout({complete:function(){e.router.navigate("#"),e.router.login()}},t)},record:function(t,n,r){e.logger.debug("Route changed: "+t+"/"+n+"/"+r),r=r||"detail",e.controller.loadView({module:t,modelId:n,action:r,layout:r})}});e.augment("router",new t,!1)}(SUGAR.App),function(e){e.augment("lang",{get:function(e,t,n){return this._get("mod_strings",e,t,n)||this._get("app_strings",e,null,n)||e},getAppString:function(e){return this._get("app_strings",e)||e},getAppListStrings:function(e){return this._get("app_list_strings",e)||{}},_get:function(t,n,r,i){var s=e.metadata.getStrings(t);s=r?s[r]:s;var o=s?this._sanitize(s[n]):null;return o&&!_.isUndefined(i)&&_.isString(o)&&o.indexOf("{{")>-1&&(n="lang."+(r?n+"."+r:n),o=Handlebars.templates[n]?Handlebars.templates[n](i):e.template.compile(n,o)(i)),o},_sanitize:function(e){return _.isString(e)&&e.lastIndexOf(":")==e.length-1?e.substring(0,e.length-1):e},getLanguage:function(){return this.currentLanguage},setLanguage:function(t,n,r){var i=this;r=r||{},_.each(Handlebars.templates,function(e,t){t.indexOf("lang.")==0&&delete Handlebars.templates[t]});if(r.noSync===!0){e.cache.set("lang",t);return}e.sync({callback:function(s){s||(i.updateLanguage(t),e.lang.hasChanged=!e.api.isAuthenticated()&&!r.noUserUpdate),n&&n(s)},getPublic:!e.api.isAuthenticated(),noUserUpdate:r.noUserUpdate||!1,language:t,metadataTypes:["labels"]})},updateLanguage:function(t){e.cache.set("lang",t),e.user.setPreference("language",t)}})}(SUGAR.App),function(app){function _setHash(e,t){var n=t?"public:":"";app.cache.set(_keyPrefix+n+"hash",e._hash)}function _cacheMeta(e){app.cache.set(_keyPrefix+"data",e)}function _getCachedMeta(){return app.cache.get(_keyPrefix+"data")}function _injectLabels(e,t){_.each(t,function(n,r){r!=="_hash"&&(e[r]=t[r])}),delete e.labels}function _fetchLabels(e,t){var n,r,i;n=e.labels,r=app.lang.currentLanguage=t.language||app.user.getLanguage()||n["default"],i=n[r],i.indexOf("../")!==0&&i.indexOf("http")!==0&&!_.isEmpty(app.config.siteUrl)&&(i=app.config.siteUrl.replace(/\/+$/,"")+"/"+i),$.ajax({url:i,timeout:t.timeout||app.api.timeout,success:function(e){try{e=_.isString(e)?JSON.parse(e):e}catch(n){app.logger.fatal("Failed to parse labels data: "+n),t.error({code:"sync_failed",label:"ERR_SYNC_FAILED"});return}t.success(e)},error:function(e,n,r){t.error(new SUGAR.Api.HttpError({xhr:e,params:{url:i}},n,r))}})}function _initCustomComponents(e,t){var n=this,r=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each({layout:"layout",view:"view",fieldTemplate:"field"},function(i,s){!_.isUndefined(e[s+"s"])&&!_.isUndefined(e[s+"s"].base)&&_.each(r,function(r){var o=e[s+"s"][r];n._sortAndDeclareComponents(o,i,t)}),_.each(e[s+"s"],function(e,n){i==="view"&&e.templates&&_.each(e.templates,function(e,n){app.template.setView(n,t,e,!0)}),i==="layout"&&e.templates&&_.each(e.templates,function(e){app.template.setLayout(n,t,e,!0)}),i==="field"&&e.templates&&_.each(e.templates,function(e,r){app.template.setField(n,r,t,e,!0)})})},this)}var _keyPrefix="meta:",_metadata={};app.augment("metadata",{fieldTypeMap:{varchar:"text",datetime:"datetimecombo",multienum:"enum",name:"text",text:"textarea",decimal:"float"},_patchMetadata:function(e,t){return!t||t._patched===!0?t:(_.each(t.views,function(n){n.meta&&_.each(n.meta.panels,function(n){n.fields=this._patchFields(e,t,n.fields)},this)},this),t._patched=!0,t)},_patchFields:function(e,t,n){var r=this;return _.each(n,function(i,s){var o=_.isString(i)?i:i.name,u=t.fields[o];if(i.fields){i.fields=r._patchFields(e,t,i.fields);return}_.isEmpty(u)?i===""&&(i={view:"detail"},n[s]=i):(_.isString(i)&&(i={name:i}),_.isObject(i.displayParams)&&(_.extend(i,i.displayParams),delete i.displayParams),i.type=i.type||u.type,i.type=r.fieldTypeMap[i.type]||i.type,i.label=i.label||u.vname||i.name,n[s]=i)},this),n},_sortControllers:function(type,components,module){var updated={},nameMap={},entries={},updateWeights=function(e){var t=e.controller;_.isObject(t)&&_.isString(t.extendsFrom)&&entries[t.extendsFrom]&&!updated[t.extendsFrom]&&(entries[t.extendsFrom].weight--,updated[t.extendsFrom]=!0,updateWeights(entries[t.extendsFrom]))};return _.each(components,function(entry,name){if(entry.controller){var controller=entry.controller,className=(module||"")+app.utils.capitalizeHyphenated(name)+app.utils.capitalize(type);nameMap[className]=name;if(_.isString(controller))try{controller=eval("["+controller+"][0]")}catch(e){app.logger.error("Failed to eval view controller for "+className+": "+e+":\n"+entry.controller)}entries[className]={type:name,controller:controller,weight:0}}}),_.each(entries,function(e){updated={},updateWeights(e)}),_.sortBy(entries,"weight")},_sortAndDeclareComponents:function(e,t,n){var r,i=this;!_.isUndefined(e)&&e&&(r=i._sortControllers(t,e,n),_.each(r,function(e){app.view.declareComponent(t,e.type,n,e.controller,!0)}))},_declareClasses:function(e){var t=this,n=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each(["field","view","layout"],function(r){var i,s;!_.isUndefined(e[r+"s"])&&!_.isUndefined(e[r+"s"].base)&&_.each(n,function(n){s=e[r+"s"][n],t._sortAndDeclareComponents(s,r)},this)},this),_.each(e.modules,function(e,t){_initCustomComponents.call(this,e,t)},this)},getModules:function(){return _metadata.modules},getModule:function(e,t){var n=this.getModules();return n&&(n=n[e]),n&&t&&(n=n[t]),n},getRelationship:function(e){return _metadata.relationships?_metadata.relationships[e]:null},getField:function(e){return _metadata.fields?_metadata.fields[e]||_metadata.base:null},getView:function(e,t){var n,r=this.getModule(e,"views");return r&&r[t]?r=r[t].meta:_metadata.views&&_metadata.views[t]&&(r=_metadata.views[t].meta),r},getLayout:function(e,t){var n,r=this.getModule(e,"layouts");return r&&r[t]?r=r[t].meta:_metadata.layouts&&_metadata.layouts[t]&&(r=_metadata.layouts[t].meta),r},getModuleNames:function(e,t){var n=_.isObject(app.user.get("module_list"))?_.toArray(app.user.get("module_list")):[];return e===!0&&app.config&&app.config.displayModules&&(n=_.intersection(n,app.config.displayModules)),t&&(n=_.filter(n,function(e){return app.acl.hasAccess(t,e)})),n},getStrings:function(e){return _metadata[e]||{}},getConfig:function(){return _metadata.config||{}},getCurrency:function(e){return this.getCurrencies()[e]},getCurrencies:function(){return _metadata.currencies||{}},getServerInfo:function(){return _metadata.server_info||{}},set:function(e,t,n){_.each(e.modules,function(e,t){this._patchMetadata(t,e)},this),this._declareClasses(e),_.each(e.config,function(e,t){app.config?app.config[t]=e:app.config={}}),app.template.set(e,e._hash&&e._hash!=this.getHash(t)),_.isEmpty(e._hash)||_setHash(e,t),n?_metadata=e:_.each(e,function(e,t){_metadata[t]=_.isObject(e)?_.extend(_metadata[t]||{},e):e}),app.config.cacheMeta&&!t&&_cacheMeta(_metadata),app.config.env!="prod"&&(this.data=_metadata)},getHash:function(e){var t=e?_keyPrefix+"public:hash":_keyPrefix+"hash";return app.cache.get(t)||_metadata._hash||""},sync:function(e,t){t=t||{};var n=this,r,i;r=t.metadataTypes||app.config.metadataTypes||[],i=function(t){app.logger.debug("Failed fetching metadata"),app.error.handleHttpError(t),e&&e.call(n,t)},app.api.getMetadata(n.getHash(t.getPublic),r,[],{success:function(s){var o,u;t=t||{};if(!_.isEmpty(s)){app.logger.debug("Updating metadata");if(_.isEmpty(r)||_.include(r,"server_info")&&!t.getPublic){u=app.isServerCompatible(s.server_info);if(u!==!0)return e(u)}s.jssource?(SUGAR.jssource=!1,o=document.createElement("script"),o.src=s.jssource,document.head.appendChild(o),_fetchLabels(s,{language:t.language,success:function(r){_injectLabels(s,r),n.set(s,t.getPublic),app.utils.doWhen("SUGAR.jssource",function(){n._declareClasses(SUGAR.jssource),e&&e.call(n)})},error:i})):_fetchLabels(s,{language:t.language,success:function(r){_injectLabels(s,r),n.set(s,t.getPublic),e&&e.call(n)},error:i})}else e&&e.call(n,{code:"sync_failed",label:"ERR_SYNC_FAILED"})},error:i},t)},init:function(){if(app.config.cacheMeta){var e=_getCachedMeta();e&&this.set(e,!1)}},clearCache:function(){app.cache.cut(_keyPrefix+"public:hash"),app.cache.cut(_keyPrefix+"hash"),app.cache.cut(_keyPrefix+"data")},reset:function(){_metadata={},this.clearCache()}},!1)}(SUGAR.App),function(e){e.augment("acl",{action2permission:{view:"read",readonly:"read",edit:"write",detail:"read",list:"read"},_hasAccess:function(e,t){var n;return t.access==="no"?n="no":n=t[e],n!=="no"},_hasAccessToField:function(e,t,n){var r;return e=this.action2permission[e]||e,t.fields[n]&&t.fields[n][e]&&(r=t.fields[n][e]),r!=="no"},hasAccess:function(t,n,r,i,s){var o=e.user.getAcls()[n],u=!0;if(o||s){o=o||{};if(s){o=JSON.parse(JSON.stringify(o)),o.fields=o.fields||{},_.extend(o.fields,s.fields);var a=o.fields;_.extend(o,s),o.fields=a}u=this._hasAccess(t,o);if(i&&o.fields&&u){u=this._hasAccessToField(t,o,i);var f=e.metadata.getModule(n),l=f&&f.fields?f.fields[i]:null;u&&l&&l.group&&(u=this._hasAccessToField(t,o,l.group))}}return u},hasAccessToModel:function(e,t,n){var r,i,s,o,u=!0;return t&&(r=t.id,i=t.module,s=t.original_assigned_user_id||t.get("assigned_user_id"),o=t._acl||{fields:{}}),e=="edit"&&!r&&(e="create"),u===!0&&(u=this.hasAccess(e,i,s,n,o)),u}})}(SUGAR.App),function(e){var t=Backbone.Model.extend({load:function(t){e.api.me("read",null,null,{success:function(n){if(n.current_user){e.user.set(n.current_user);var r=e.user.getPreference("language");e.lang.getLanguage()!=r&&e.lang.setLanguage(r,null,{noUserUpdate:!0,noSync:!0})}t&&t()},error:function(n){e.error.handleHttpError(n),t&&t(n)}})},getLanguage:function(){return e.user.getPreference("language")||e.cache.get("lang")},updateLanguage:function(t,n){var r=function(){e.lang.updateLanguage(t),n&&n()};e.api.isAuthenticated()?e.api.me("update",{preferred_language:t},null,{success:function(){r()},error:function(t){e.error.handleHttpError(t),n&&n(t)}}):r()},getAcls:function(){return e.user.get("acl")||{}},getPreference:function(t){var n=e.user.get("preferences")||{};return n[t]},setPreference:function(t,n){var r=e.user.get("preferences")||{};return r[t]=n,e.user.set("preferences",r)}});e.events.on("app:logout",function(t){t===!0&&e.user.clear({silent:!0})}),e.augment("user",new t,!1)}(SUGAR.App),function(e){e.augment("logger",{levels:{TRACE:{value:1,name:"TRACE"},DEBUG:{value:2,name:"DEBUG"},INFO:{value:3,name:"INFO"},WARN:{value:4,name:"WARN"},ERROR:{value:5,name:"ERROR"},FATAL:{value:6,name:"FATAL"}},ConsoleWriter:{write:function(t,n){window.console||(window.console={}),window.console.log||(window.console.log=function(){}),t.value<=e.logger.levels.INFO.value?console.log(n):t.value==e.logger.levels.WARN.value?console.warn(n):console.error(n)}},SimpleFormatter:{format:function(e,t,n){var r=n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-"+n.getUTCDate()+" "+n.getUTCHours()+":"+n.getUTCMinutes()+":"+n.getUTCSeconds();return e.name+"["+r+"]: "+t}},trace:function(e){this.log(this.levels.TRACE,e)},debug:function(e){this.log(this.levels.DEBUG,e)},info:function(e){this.log(this.levels.INFO,e)},warn:function(e){this.log(this.levels.WARN,e)},error:function(e){this.log(this.levels.ERROR,e)},fatal:function(e){this.log(this.levels.FATAL,e)},log:function(t,n){try{n=n||"<none>";var r=this.levels[e.config.logLevel]||this.levels.ERROR,i=this[e.config.logWriter]||this.ConsoleWriter,s=this[e.config.logFormatter]||this.SimpleFormatter;if(t.value>=r.value){_.isFunction(n)&&(n=n.call(this));if(_.isObject(n))try{n=JSON.stringify(n)}catch(o){n=n.toString()}i.write(t,s.format(t,n,new Date))}}catch(o){console.log("Failed to log message {"+n+"} due to exception: "+o)}}},!1)}(SUGAR.App),function(e){function t(e,t,n,r){if(_.isUndefined(t))return;_.isUndefined(e[n])&&(e[n]={}),e[n][r]=t}e.augment("Bean",Backbone.Model.extend({initialize:function(e){Backbone.Model.prototype.initialize.call(this,e),this._relatedCollections=null,this.isNew()&&this._defaults&&this.set(this._defaults,{silent:!0})},_setRelatedCollection:function(e,t){this._relatedCollections||(this._relatedCollections={}),this._relatedCollections[e]=t},getRelatedCollection:function(t){return this._relatedCollections&&this._relatedCollections[t]?this._relatedCollections[t]:e.data.createRelatedCollection(this,t)},isValid:function(e){var t=this._doValidate(e);return this._processValidationErrors(t)},_doValidate:function(n){var r,i={};return _.each(n||this.fields,function(n,s){_.isString(n)&&(s=n,n=this.fields[s]),r=this.get(s),n&&(t(i,e.validation.requiredValidator(n,n.name,this,r),s,"required"),r&&_.each(e.validation.validators,function(e,o){t(i,e(n,r),s,o)}))},this),i},_processValidationErrors:function(t){var n=!0;return _.isEmpty(t)||(e.error.handleValidationError(this,t),_.each(t,function(e,t){this.trigger("error:validation:"+t,e)},this),this.trigger("error:validation",t),n=!1),n},save:function(e,t){var n=!0;return t&&t.fieldsToValidate&&(n=this.isValid(t.fieldsToValidate)),n?Backbone.Model.prototype.save.call(this,e,t):!1},canHaveAttachments:function(){return _.has(this.fields,"attachment_list")},getFiles:function(t,n){return n=n||{},n.passOAuthToken=!1,e.api.file("read",{module:this.module,id:this.id},null,t,n)},copy:function(t,n,r){var i={},s=e.metadata.getModule(this.module).fields;n=n||_.pluck(s,"name"),_.each(n,function(e){var n=s[e];if(n&&e!="id"&&n.type!="link"&&!n.auto_increment&&t.has(e)){var r=t.get(e);_.isObject(r)&&(r=JSON.parse(JSON.stringify(r))),i[e]=r}}),this.set(i,r)},uploadFile:function(t,n,r,i){return r=r||{},e.api.file("create",{id:this.id,module:this.module,field:t},n,{success:function(e,n,i){var s=e[t];if(s)r.success&&r.success(e);else{var o=new SUGAR.Api.HttpError({xhr:i});o.responseText=e.xhr?e.xhr.message:o.responseText,r.error&&r.error(o)}}},i)},favorite:function(e,t){return t=t||{},t.favorite=!0,this.save({my_favorite:!!e},t)},isFavorite:function(){var e=this.get("my_favorite");return e==="1"||e===!0},toString:function(){return"bean:"+this.module+"/"+(this.id?this.id:"<no-id>")}}),!1)}(SUGAR.App),function(e){e.augment("BeanCollection",Backbone.Collection.extend({constructor:function(e,t){t&&t.link&&(this.link=t.link,delete t.link),Backbone.Collection.prototype.constructor.call(this,e,t)},_prepareModel:function(e,t){var n=e._acl,r=e._search;return delete e._acl,delete e._search,e=Backbone.Collection.prototype._prepareModel.call(this,e,t),e&&!e.link&&(e.link=this.link),n&&(e._acl=n),r&&(e.searchInfo=r),e},fetch:function(e){return e=e||{},e.fields=this.fields=e.fields||this.fields||null,e.myItems=_.isUndefined(e.myItems)?this.myItems:e.myItems,e.favorites=_.isUndefined(e.favorites)?this.favorites:e.favorites,e.query=_.isUndefined(e.query)?this.query:e.query,Backbone.Collection.prototype.fetch.call(this,e)},paginate:function(t){t=t||{},t.page=t.page||1,t.page--,e.config.maxQueryResult&&(t.offset=this.offset+t.page*e.config.maxQueryResult),this.fetch(t)},getPageNumber:function(){var t=1;return this.offset&&e.config.maxQueryResult&&(t=Math.ceil(this.offset/e.config.maxQueryResult)),t},toString:function(){return"coll:"+(this.link?this.link.bean.module+"/"+this.link.bean.id+"/":"")+this.module+"-"+this.length}}),!1)}(SUGAR.App),function(e){e.augment("MixedBeanCollection",e.BeanCollection.extend({_prepareModel:function(t,n){var r=t instanceof e.Bean?t.module:t._module;return this.model=e.data.getBeanClass(r),e.BeanCollection.prototype._prepareModel.call(this,t,n)},fetch:function(t){return t=t||{},t.module_list=this.module_list=t.module_list||this.module_list||e.metadata.getModuleNames(),e.BeanCollection.prototype.fetch.call(this,t)},groupByModule:function(){return _.groupBy(this.models,function(e){return e.module})},toString:function(){return"mcoll:"+this.length}}),!1)}(SUGAR.App),function(e){var t={},n={},r=_.extend({beanModel:e.Bean,beanCollection:e.BeanCollection,init:function(){var t=_.bind(this.sync,this);e.Bean.prototype.sync=t,e.BeanCollection.prototype.sync=t,e.events.register("data:sync:start",this),e.events.register("data:sync:end",this)},reset:function(e){e?(delete t[e],delete n[e]):(t={},n={})},declareModel:function(e,r){this.reset(e);var i=r?r.fields:{},s=null;_.each(_.values(i),function(e){_.isUndefined(e["default"])||(s===null&&(s={}),s[e.name]=e["default"])});var o=this.beanModel.extend({_defaults:s,module:e,fields:i});n[e]=this.beanCollection.extend({model:o,module:e,offset:0}),t[e]=o},declareModels:function(t){t=t||e.metadata.getModules(),_.each(t,function(e,t){this.declareModel(t,e)},this)},getBeanClass:function(e){return t[e]||Backbone.Model},createBean:function(e,n){return t[e]?new t[e](n):new Backbone.Model},createBeanCollection:function(e,t,r){return n[e]?new n[e](t,r):new Backbone.Collection},createRelatedBean:function(e,t,n,r){var i=this.getRelatedModule(e.module,n);return r=r||{},_.isString(t)?(r.id=t,t=this.createBean(i,r)):_.isNull(t)?t=this.createBean(i,r):t.set(r),t.link={name:n,bean:e,isNew:!0},t},createRelatedCollection:function(e,t,n){var r=this.getRelatedModule(e.module,t),i=this.createBeanCollection(r,n,{link:{name:t,bean:e}});return e._setRelatedCollection(t,i),i},createMixedBeanCollection:function(t){return new e.MixedBeanCollection(t)},canHaveMany:function(t,n){var r=e.metadata.getModule(t),i=r.fields[n].relationship,s=e.metadata.getRelationship(i),o=s.relationship_type.split("-"),u=t===s.rhs_module?o[0]:o[2];return u==="many"},getRelateFields:function(t,n){var r=e.metadata.getModule(t).fields[n].relationship,i=this.getRelatedModule(t,n),s=e.metadata.getModule(i).fields,o=_.find(s,function(e){return e.type=="link"&&e.relationship==r});return o&&(o=_.filter(s,function(e){return e.type=="relate"&&e.link==o.name})),o||[]},getRelationshipFields:function(t,n){var r=null,i=e.metadata.getModule(t).fields[n];if(i.rel_fields){var s=i.relationship,o=this.getRelatedModule(t,n),u=e.metadata.getModule(o).fields,a=_.find(u,function(e){return e.type=="link"&&e.relationship==s});a&&(a=_.find(u,function(e){return e.link==a.name&&e.link_type=="relationship_info"}));if(a&&a.relationship_fields){var f=_.keys(i.rel_fields);_.each(a.relationship_fields,function(e,t){_.include(f,t)&&(r||(r=[]),r.push(e))})}}return r},getRelatedModule:function(t,n){var r=e.metadata.getModule(t),i=r.fields[n].relationship,s=e.metadata.getRelationship(i);return t===s.rhs_module?s.lhs_module:s.rhs_module},getEditableFields:function(t,n){var r={},i=t.module,s,o=["parent","relate"];n=n||[],n.length==0&&_.each(t.attributes,function(e,t){n.push(t)});if(i)var s=e.metadata.getModule(i);return r.id=t.get("id"),_.each(n,function(n){t.has(n)&&s&&s.fields[n]&&(!s.fields[n].source||s.fields[n].source!=="non-db"||!s.fields[n].type||o.indexOf(s.fields[n].type)===-1)&&e.acl.hasAccessToModel("edit",t,n)&&(r[n]=t.get(n))}),r},sync:function(t,n,r){var i=this;e.logger.trace("remote-sync-"+(r.relate?"relate-":"")+t+": "+n),r=r||{},r.params=r.params||{},r.fields&&t=="read"&&(r.params.fields=r.fields.join(","));if(t=="read"&&n instanceof e.BeanCollection){r.offset&&r.offset!==0&&(r.params.offset=r.offset);if(r.limit||e.config&&e.config.maxQueryResult)r.params.max_num=r.limit||e.config.maxQueryResult;n.orderBy&&n.orderBy.field&&(r.params.order_by=n.orderBy.field+":"+n.orderBy.direction),r.myItems===!0&&(r.params.my_items="1"),r.favorites===!0&&(r.params.favorites="1"),_.isEmpty(r.query)||(r.params.q=r.query),r.module_list&&(r.params.module_list=r.module_list.join(","))}var s=function(i){n.original_assigned_user_id=n.get("assigned_user_id"),t=="read"&&n instanceof e.BeanCollection?(i.next_offset&&(n.offset=i.next_offset!=-1?i.next_offset:n.offset+(i.records||[]).length,n.next_offset=i.next_offset,n.page=n.getPageNumber()),i=i.records||[],n.myItems=r.myItems,n.favorites=r.favorites,n.query=r.query,n.modelList=r.modelList):t=="read"&&n instanceof e.Bean&&(n._acl=i._acl||{},delete i._acl),r.relate===!0&&(n.link.isNew=!1,t!="read"&&(n.link.bean&&n.link.bean.set(i.record),i=i.related_record,t=="delete"&&(n.set(i),delete n.link))),r.success&&r.success(i)},o,u=function(t){o=t,e.error.handleHttpError(t,n),r.error&&r.error(t)},a=function(){i.trigger("data:sync:end",t,n,r,o),r.complete&&r.complete()},f={success:s,error:u,complete:a};this.trigger("data:sync:start",t,n,r);if(r.relate===!0){var l=null;if(t=="create"||t=="update")l=this.getEditableFields(n,r.fields),t=="update"&&n.link.isNew&&(t="create");e.api.relationships(t,n.link.bean.module,{id:n.link.bean.id,link:n.link.name,relatedId:n.id,related:l},r.params,f)}else r.favorite?e.api.favorite(n.module,n.id,n.isFavorite(),f):_.isFunction(e.MixedBeanCollection)&&n instanceof e.MixedBeanCollection?e.api.search(r.params,f):e.api.records(t,n.module,t=="update"||t=="create"?this.getEditableFields(n,r.fields):n.attributes,r.params,f)}},Backbone.Events);e.augment("data",r,!1)}(SUGAR.App),function(e){e.augment("validation",{validators:function(){var t=function(e,t,n){var r=_.isUndefined(e[n])?e.validation?e.validation[n]:null:e[n];if(e.type=="int"&&_.isFinite(r)){t=parseInt(t);if(n=="max"){if(t>r)return r}else if(t<r)return r}};return{maxLength:function(e,t){if(_.isNumber(e.len)){var n=e.len;t=t||"",t=t.toString();if(t.length>n)return n}},minLength:function(e,t){if(_.isNumber(e.minlen)){var n=e.minlen;t=t||"",t=t.toString();if(t.length<n)return n}},url:function(e,t){},email:function(t,n){var r;if(t.type=="email"){n.length>0&&_.each(n,function(t){e.utils.isValidEmailAddress(t.email_address)||(r||(r=[]),r.push(t.email_address))});if(r&&r.length>0)return r}},datetime:function(t,n){function c(e,t,n){var r=parseInt(e,10);return!isNaN(r)&&r>=t&&r<=n}var r,i,s,o,u,a,f,l;if(t.type==="date"||t.type==="datetimecombo"){if(_.isNaN(Date.parse(n))&&_.isNaN(Date.parse(n.replace(/[\.\-]/g,"/"))))return n;if(!e.date.isIso(n)){a=n.replace(/[\.\-]/g,"/").split("/"),i=_.filter(a,function(e,t){return e.length===3||e.length>4});if(i.length)return n;if(/([\.\/\-])\1/.test(n)===!0)return n;s=e.user.getPreference("datepref"),o=s.match(/[.\/\-\s].*?/),u=s.split(o);for(f=0,l=u.length;f<l;f++){r=a[f];switch(u[f].toLowerCase().charAt(0)){case"m":if(!c(r,1,12))return n;break;case"d":if(!c(r,1,31))return n}}}else if(n.charAt(0)==="0")return n}},minValue:function(e,n){return t(e,n,"min")},maxValue:function(e,n){return t(e,n,"max")},number:function(e,t){if(_.indexOf(["int","float","currency"],e.type)!=-1)return _.isBoolean(t)||_.isString(t)&&t.trim().length==0||isNaN(parseFloat(t))?!0:undefined}}}(),requiredValidator:function(e,t,n,r){if(e.required===!0&&t!=="id"&&_.isUndefined(e.auto_increment)){var i=n.get(t),s=_.isUndefined(i),o=_.isNull(r)||r===""||_.isArray(r)&&r.length==0;if(s&&_.isUndefined(r)||o)return!0}}},!1)}(SUGAR.App),function(e){Handlebars.registerHelper("field",function(t,n,r){n instanceof Backbone.Model||(n=null),_.isString(r)||(r=null);var i=e.view.createField({def:this,view:t,model:n,viewName:r});return i.getPlaceholder()}),Handlebars.registerHelper("fieldOfType",function(t,n){var r={type:t,name:t,label:n},i=e.view.createField({def:r,view:this});return i.getPlaceholder()}),Handlebars.registerHelper("fieldWithName",function(t,n,r,i){r instanceof Backbone.Model||(r=null),i=_.isString(i)?i:null;var s=e.view.createField({def:{name:n,type:"base"},view:t,model:r,viewName:i||null});return s.getPlaceholder()}),Handlebars.registerHelper("eachOptions",function(t,n){var r,i="",s;return r=_.isString(t)?e.lang.getAppListStrings(t):t,_.isArray(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:_.isObject(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:r=null,r&&_.each(r,s,this),i}),Handlebars.registerHelper("buildRoute",function(t,n,r,i){n=n||t.get("model");var s=n.id;return i=i||{},r=="create"&&(s=""),new Handlebars.SafeString(e.router.buildRoute(t.get("module"),s,r,i))}),Handlebars.registerHelper("modelRoute",function(t,n){n=_.isString(n)?n:null;var r=n=="create"?"":t.id;return new Handlebars.SafeString(e.router.buildRoute(t.module,r,n))}),Handlebars.registerHelper("getFieldValue",function(e,t,n){return e.get(t)||n||""}),Handlebars.registerHelper("has",function(e,t,n){return!_.isArray(t)&&!_.isObject(t)&&(t=[t]),_.include(t,e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notHas",function(e,t,n){var r=n.fn,i=n.inverse;return n.fn=i,n.inverse=r,Handlebars.helpers.has.call(this,e,t,n)}),Handlebars.registerHelper("isSortable",function(t,n,r){var i=e.metadata.getModule(t).fields[n.name];return(_.isUndefined(n.sortable)?_.isUndefined(i.sortable)?!0:i.sortable:n.sortable)?r.fn(this):""}),Handlebars.registerHelper("eq",function(e,t,n){return e==t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notEq",function(e,t,n){return e!=t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("match",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notMatch",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.inverse(this):n.fn(this)}),Handlebars.registerHelper("log",function(t){e.logger.debug("*****HBT: Current Context*****"),e.logger.debug(this),e.logger.debug("*****HBT: Current Value*****"),e.logger.debug(t),console.log(t),e.logger.debug("***********************")}),Handlebars.registerHelper("str",function(t,n,r){return n=_.isString(n)?n:null,e.lang.get(t,n,r)}),Handlebars.registerHelper("timeago",function(e,t){var t=_.isString(t)?" data-label='"+t+"' ":"",n='<span class="relativetime" '+t+' title="'+e+'">'+e+"</span>";return new Handlebars.SafeString(n)}),Handlebars.registerHelper("arrayJoin",function(e,t){return e.join(t)}),Handlebars.registerHelper("nl2br",function(e){return _.isString(e)?(e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),new Handlebars.SafeString(e.replace(/(\r)?\n/g,"<br>"))):""}),Handlebars.registerHelper("formatCurrency",function(t,n){return e.currency.formatAmountLocale(t,n)})}(SUGAR.App),function(e){var t=0,n=[],r=function(e,t,r,i){var s=null,o=null;return _.isObject(i)?(t=_.isObject(i.extendsFrom)?i.extendsFrom:e[i.extendsFrom]||t,s=e[r]=t.extend(i)):s=e[r]=t,n.push(r),s},i={reset:function(){var e;for(var t=0;t<n.length;++t)e=n[t],delete this.layouts[e],delete this.views[e],delete this.fields[e];n=[]},getFieldId:function(){return t},views:{},layouts:{},fields:{},_createComponent:function(e,t,n){var r=this.declareComponent(e,n.type||t,n.module,n.controller),i=new r(n);return i.bindDataChange(),i},createView:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getView(t.module,t.name),this._createComponent("view",t.name,t)},createLayout:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getLayout(t.module,t.name),t.type=t.type||(t.meta?t.meta.type:null),this._createComponent("layout",t.name||t.type,t)},createField:function(n){var r=n.def.type;n.context=n.context||n.view.context||e.controller.context,n.model=n.model||n.context.get("model"),n.module=n.module||(n.model&&n.model.module?n.model.module:n.context.get("module"))||"",n.meta=n.meta||e.metadata.getField(r,n.module),n.meta&&n.meta.controller&&(n.controller=n.meta.controller),n.sfId=++t;var i=this._createComponent("field",r,n);return n.view.fields[i.sfId]=i,i},declareComponent:function(t,n,i,s,o){var u=e.utils.capitalize(t),a=e.utils.capitalizeHyphenated(n)+u,f=(i||"")+a,l=e.view[t+"s"],c=e.utils.capitalize(e.config.appId)+u,h=l[a]||l["Base"+u]||e.view[c]||e.view[u];return o&&s&&l[f]&&delete l[f],l[f]||r(l,h,f,s)||h},getComponentClassName:function(e,t,n){}};e.augment("view",i,!1)}(SUGAR.App),function(e){e.view.Component=Backbone.View.extend({initialize:function(t){this.context=t.context||e.controller.context,this.meta=t.meta,this.module=t.module||this.context.get("module"),this.model=t.model||this.context.get("model"),this.collection=t.collection||this.context.get("collection"),this.meta&&this.meta.css_class&&this.$el.addClass(this.meta.css_class
)},before:function(e,t,n,r){var i=this._before=this._before||{};return i[e]=i[e]||[],i[e].push({fn:t,params:n,overrideContext:r}),this},triggerBefore:function(e,t){var n=!1;if(this._before&&this._before[e]){var r=this._before[e];for(var i=0;i<r.length;i++){var s=r[i],o=this;s.overrideContext&&(s.overrideContext===!0?o=s.params:o=s.overrideContext),t&&s.params?s.params=_.extend(t,s.params):s.params=s.params||t,s.fn&&(n=n||s.fn.call(o,s.params)===!1)}}return!n},offBefore:function(e,t,n){if(!e)return delete this._before;var r=this._before=this._before||{};if(!r[e])return!1;if(!t&&!n)return delete r[e];var i=r[e];for(var s=i.length-1;s>=0;s--){var o=i[s],u=this;o.overrideContext&&(o.overrideContext===!0?u=item.params:u=item.overrideContext),o.fn==t&&(!n||n==u)&&i.splice(s,1)}return!0},_render:function(){},render:function(){if(this.disposed===!0)throw new Error("Unable to render component because it's disposed: "+this);return this.triggerBefore("render")?(this._render(),this.trigger("render"),this):!1},bindDataChange:function(){},unbindData:function(){this.model&&this.model.off(null,null,this),this.collection&&this.collection.off(null,null,this)},unbind:function(){this.off(),this.offBefore(),this.undelegateEvents(),e.events.off(null,null,this),e.events.unregister(this)},loadData:function(){},_dispose:function(){this.unbindData(),this.unbind(),this.remove(),this.model=null,this.collection=null,this.context=null},dispose:function(){if(this.disposed===!0)return;this._dispose(),this.disposed=!0},remove:function(){return this.$el.remove()},toString:function(){return this.cid+"-"+(this.$el&&this.$el.id?this.$el.id:"<no-id>")+"/"+this.module+"/"+this.model+"/"+this.collection},show:function(){this.$el.removeClass("hide").show()},hide:function(){this.$el.addClass("hide").hide()}})}(SUGAR.App),function(e){e.view.View=e.view.Component.extend({initialize:function(t){e.view.Component.prototype.initialize.call(this,t),this.name=t.name,this.action=t.meta&&t.meta.action?t.meta.action:this.name,this.template=t.template||e.template.getView(this.name,this.module)||e.template.getView(this.name)||(t.meta&&t.meta.type?e.template.getView(t.meta.type):null),this.fields={},this.fallbackFieldTemplate=this.fallbackFieldTemplate||"detail",this.layout=this.options.layout,this._setLabels(),e.config.env=="dev"&&this.$el.data("comp","view_"+this.name)},setTemplateOption:function(e,t){this.options=this.options||{},this.options.templateOptions=this.options.templateOptions||{},this.options.templateOptions[e]=_.extend({},this.options.templateOptions[e],t)},_renderHtml:function(t,n){if(this.template)try{this.$el.html(this.template(t||this,n||this.options.templateOptions)),this.delegateEvents()}catch(r){e.logger.error("Failed to render "+this+"\n"+r),e.error.handleRenderError(this,"_renderHtml")}},_renderField:function(t){t.setElement(this.$("span[sfuuid='"+t.sfId+"']"));try{t.render()}catch(n){e.logger.error("Failed to render "+t+" on "+this+"\n"+n),e.error.handleRenderError(this,"_renderField",t)}},_render:function(){return e.acl.hasAccessToModel(this.action,this.model)?(_.each(this.fields,function(e){e.dispose()}),this.fields={},this._renderHtml(),_.each(this.fields,function(e){this._renderField(e)},this)):(e.logger.info("Current user does not have access to this module view. name: "+this.name+" module:"+this.module),this.context.get("link")||e.error.handleRenderError(this,"view_render_denied")),this},_setLabels:function(){this.modulePlural=e.lang.getAppListStrings("moduleList")[this.module]||this.module,this.moduleSingular=e.lang.getAppListStrings("moduleListSingular")[this.module]||this.modulePlural},loadData:function(t){e.acl.hasAccess("read",this.module)&&(this.context.set("fields",this.getFieldNames()),this.context.loadData(t))},getFieldNames:function(t){var n=[];t=t||this.context.get("module"),this.meta&&this.meta.panels&&(n=_.reduce(_.map(this.meta.panels,function(e){var t=_.flatten(_.compact(_.pluck(e.fields,"fields")));return _.pluck(e.fields,"name").concat(_.pluck(t,"name")).concat(_.flatten(_.compact(_.pluck(e.fields,"related_fields"))))}),function(e,t){return e.concat(t)},[])),n=_.compact(_.uniq(n));var r=e.metadata.getModule(t,"fields");if(r){n=_.reject(n,function(e){return _.isUndefined(r[e])});var i=[];_.each(n,function(e){r[e].type=="relate"?i.push(r[e].id_name):r[e].type=="parent"&&(i.push(r[e].id_name),i.push(r[e].type_name))}),n=n.concat(i)}return n},getFields:function(e){var t={},n=this.getFieldNames(e);return _.each(this.fields,function(e){_.include(n,e.name)&&(t[e.name]=e.def)}),t},getField:function(e){return _.find(this.fields,function(t){return t.name==e})},_dispose:function(){_.each(this.fields,function(e){e.dispose()}),this.fields={},e.view.Component.prototype._dispose.call(this)},toString:function(){return"view-"+this.name+"-"+e.view.Component.prototype.toString.call(this)}})}(SUGAR.App),function(app){app.view.Field=app.view.Component.extend({fieldTag:"input",initialize:function(e){app.view.Component.prototype.initialize.call(this,e),this.sfId=e.sfId,this.view=e.view,this.name=this.options.def.name,this.type=this.options.def.type;if(this.model&&this.model.fields){var t=_.clone(this.model.fields[this.name]);this.def=t?_.extend(t,e.def):e.def}else this.def=this.options.def;this.label=app.lang.get(this.def.label||this.def.vname||this.name,this.module),this.template=app.template.empty,this.model&&this.model.on("error:validation:"+this.name,this.handleValidationError,this)},viewFallbackMap:{edit:"detail"},_loadTemplate:function(){var e,t=this.options.def.view||this.options.viewName||(this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name),n=t!=this.view.action?this.view.action:t;while(t){if(app.acl.hasAccessToModel(n,this.model,this.name))break;t=this.viewFallbackMap[t],n=t}if(t){var r=this.context.get("module");e=this.view.fallbackFieldTemplate||"detail",this.template=app.template.getField(this.type,t,r,e)||app.template.getField("base",t,r,e)||app.template.empty}else this.template=app.template.empty;this.tplName=t,this.action=n},delegateEvents:function(events){events=events||this.events||(this.def?this.def.events:null);if(!events)return;events=_.clone(events),_.each(events,function(eventHandler,handlerName){var callback=this[eventHandler];if(!callback&&_.isString(eventHandler))try{callback=eval("["+eventHandler+"][0]"),_.isFunction(callback)&&(this["callback_"+handlerName]=callback,events[handlerName]="callback_"+handlerName)}catch(e){app.logger.error("Failed to set up event callback '"+handlerName+"' in "+this+"; error: "+e+"\n---\n"+eventHandler),delete events[handlerName]}},this),Backbone.View.prototype.delegateEvents.call(this,events)},_render:function(){this._loadTemplate(),this.model instanceof Backbone.Model&&(this.value=this.format(this.model.has(this.name)?this.model.get(this.name):"")),this.unbindDom();var e=this.template(this)||"";return app.config.env==="test"?this.$el.html(e).addClass("fld_"+this.name):this.$el.html(e),this.def&&this.def.css_class&&this.getFieldElement().addClass(this.def.css_class),this.bindDomChange(),this},getFieldElement:function(){return this.$el},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var e=this,t=this.$el.find(this.fieldTag);t.on("change",function(){e.model.set(e.name,e.unformat(t.val()))}),$.browser.msie&&t.is("input")&&t.on("input",function(){t.focus()})},bindDataChange:function(){this.model&&this.model.on("change:"+this.name,this.render,this)},format:function(e){return e},unformat:function(e){return e},handleValidationError:function(e){},getPlaceholder:function(){return new Handlebars.SafeString('<span sfuuid="'+this.sfId+'"></span>')},setDisabled:function(e){this.def.css_class=this.def.css_class||"",this.getFieldElement().removeClass(this.def.css_class);var t=this.def.css_class.split(" ");_.isUndefined(e)||e?(this._previousViewName=this.options.viewName,this.options.viewName="detail",t.push("disabled")):this._previousViewName?(this.options.viewName=this._previousViewName,t=_.without(t,"disabled")):(delete this.options.viewName,t=_.without(t,"disabled")),this.def.css_class=_.unique(_.compact(t)).join(" "),this.render()},unbindDom:function(){this.$el.find(this.fieldTag).off()},_dispose:function(){this.unbindDom(),app.view.Component.prototype._dispose.call(this)},toString:function(){return"field-"+this.name+"-"+this.sfId+"-"+app.view.Component.prototype.toString.call(this)}})}(SUGAR.App),function(e){e.view.Layout=e.view.Component.extend({initialize:function(t){e.view.Component.prototype.initialize.call(this,t),this._components=[];if(!this.meta)return;this.type=this.meta.type||this.options.type,this.name=this.meta.name||this.options.name||this.type||"",this.template=e.template.getLayout(this.name,this.module)||e.template.getLayout(this.type,this.module),this.template&&this.$el.html(this.template(this.context,t)),this.layout=this.options.layout;var n=this.module?"layout_"+this.module:"layout_"+this.meta.type;(e.config.env==="test"||e.config.env==="dev")&&this.$el.addClass(n),this._addComponentsFromDef(this.meta.components)},_addComponentsFromDef:function(e){this._addComponentsFromMetadata({components:e})},_addComponentsFromMetadata:function(t){var n=t.context||this.context,r=t.module||this.module;_.each(t.components||{},function(t){t.context&&(n=this.context.getChildContext(t.context),n.prepare(),r=n.get("module")),t.view?(view=e.view.createView({context:n,name:t.view,module:r,layout:this}),this.addComponent(view,t)):t.layout?_.isString(t.layout)?this.addComponent(e.view.createLayout({context:n,name:t.layout,module:r,layout:this}),t):_.isObject(t.layout)&&this.addComponent(e.view.createLayout({context:n,module:r,meta:t.layout,name:t.layout.name||t.layout.type||"",layout:this}),t):e.logger.warn("Invalid layout definition:\n"+t.layout)},this)},addComponent:function(e,t){e.layout||(e.layout=this),this._components.push(e),this._placeComponent(e,t)},_placeComponent:function(e){this.$el.append(e.el)},removeComponent:function(e){var t=_.isNumber(e)?e:this._components.indexOf(e);if(t>-1){var n=this._components.splice(t,1);n[0].layout=null}},getComponent:function(e){return _.find(this._components,function(t){return t.name===e})},_render:function(){return this._components&&this._components.length>0&&_.each(this._components,function(e){e.render()},this),this},loadData:function(e){this.context.set("fields",this.getFieldNames()),this.context.loadData(e),_.each(this._components,function(t){t.loadData(e)})},getFieldNames:function(e){var t=[];return e=e||this.module,_.each(this._components,function(n){n.module==e&&(t=_.union(t,n.getFieldNames()))},this),t},getFields:function(e){var t={};return _.each(this._components,function(n){_.extend(t,n.getFields(e))}),t},_dispose:function(){_.each(this._components,function(e){e.dispose()}),this._components=[],e.view.Component.prototype._dispose.call(this)},toString:function(){return"layout-"+(this.options.type||this.options.name)+"-"+e.view.Component.prototype.toString.call(this)}})}(SUGAR.App),function(e){var t={},n={init:function(){this.$alerts=$(e.config.alertsEl||"#alerts"),this.klass=e.view[e.utils.capitalize(e.config.appId)+"AlertView"]||e.view[e.utils.capitalize(e.config.platform)+"AlertView"]||e.view.views.AlertView||e.view.AlertView},show:function(e,n){if(this.$alerts.length==0)return null;n=_.extend({level:"info",autoClose:!1},n||{}),_.isUndefined(n.closeable)&&(n.closeable=n.level!="info"),n.messages&&(n.messages=_.isString(n.messages)?[n.messages]:n.messages);var r=t[e];r||(r=this._create(e,n),t[e]=r),r.level=n.level,!n.autoClose||this._setAutoCloseTimer(r,n.onAutoClose),r.render(n);if(n.closeable){var i=r.getCloseSelector();i.off("click"),i.on("click",_.bind(function(){this.dismiss(e)},this))}return r},_create:function(e,t){var n=new this.klass(t);return n.key=e,n.$el.prependTo(this.$alerts),n},_setAutoCloseTimer:function(t,n){t.timerId&&clearTimeout(t.timerId),t.timerId=setTimeout(_.bind(function(){_.isFunction(n)&&n(t.key),this.dismiss(t.key)},this),e.config.alertAutoCloseDelay||9e3)},dismiss:function(e){var n=t[e];if(!n)return;n.timerId&&clearTimeout(n.timerId),n.close(),delete t[e]},dismissAll:function(e){_.each(t,function(t,n){(!e||t.level==e)&&this.dismiss(n)},this)},get:function(e){return t[e]},getAll:function(){return t}};e.augment("alert",n,!1),e.view.AlertView=e.view.View.extend({className:"alert",tpl:"alert",close:function(){this.getCloseSelector().off("click"),this.$el.remove()},getCloseSelector:function(){return this.$(".close")},render:function(t){t=t||{},t.closeable&&this.$el.addClass("closeable"),this.$el.addClass("alert-"+t.level);var n=e.template.get(t.tpl||this.tpl)||e.template.empty;this.$el.html(n(t))}})}(SUGAR.App),function(e){var t=function(t,n){this.options=e.extend({},e.fn.searchahead.defaults,n),this.$element=e(t),this.request=this.options.request,this.compiler=this.options.compiler,this.$button=this.options.buttonElement?e(this.options.buttonElement):null,this.throttle=this.options.throttle||this.throttle,this.throttleMillis=this.options.throttleMillis||this.throttleMillis,this.$menu=e(this.options.menu).appendTo(this.$element.parent().parent()),this.shown=!1,this.minChars=this.options.minChars||1,this.patchIfZepto(),this.listen(),this.onEnterFn=this.options.onEnterFn||null};t.prototype={constructor:t,compile:function(e){return this.compiler({data:e,term:encodeURIComponent(this.query)})},disabled:!1,enable:function(){this.disabled=!1},disable:function(e){var t=this;t.disabled=!0,t.hide(),setTimeout(function(){t.hide()},t.throttleMillis),setTimeout(function(){t.enable()},e)},throttleMillis:250,throttle:function(e,t){var n=null;n=setTimeout(function(){e()},t)},go:function(){var e=null,t=null,n=null;return e=this.$menu.find(".active"),t=e.find("a").attr("href"),t?this.onEnterFn?this.onEnterFn(t,!0):window.location=t:(n=encodeURIComponent(this.$element.val()),n&&n.length&&this.onEnterFn&&this.onEnterFn(n,!1)),this.hide()},show:function(){return this.$menu.show(),this.shown=!0,this.disabled?null:(this.$menu.show(),this.shown=!0,this)},hide:function(){return this.$menu.hide(),this.shown=!1,this},buttonLookup:function(e){e.stopPropagation(),e.preventDefault(),this.lookup(e),this.$element.focus()},lookup:function(e){var t=this,n;this.query=this.$element.val();if(!this.query)return this.shown?this.hide():this;this.onSearch(e)},onSearch:function(t){var n=this;e.inArray(t.keyCode,[40,38,9,13,27])===-1&&(t.preventDefault(),n.throttle(function(){n.query=n.$element.val(),n.query&&n.query.length>=n.minChars?n.request(n.query):n.hide()},n.throttleMillis))},provide:function(t){var n,r=this.compile(t),i=this;n=r.replace(/^\s+/,"").replace(/\s+$/,"");if(n.length){r=r.replace(/^(?:\s*<li\>\s*)/,function(e,t,n,r,i){return'<li class="active">'}),e(r).first().addClass("active"),i.$menu.html(r);if(!i.disabled)return i.show()}return null},move:function(t,n){var r=this.$menu.find(".active").removeClass("active"),i;n==="next"?i=r.next():i=r.prev(),i.length||(i=e(this.$menu.find("li")[0])),i.addClass("active")},next:function(e){this.move(e,"next")},prev:function(e){this.move(e,"prev")},patchIfZepto:function(){_.isUndefined(window.Zepto)||(e.support={},e.proxy=function(t,n){var r,i,s;return typeof n=="string"&&(i=t[n],n=t,t=i),e.isFunction(t)?(r=Array.prototype.slice.call(arguments,2),s=function(){return t.apply(n,r.concat(Array.prototype.slice.call(arguments)))},s.guid=t.guid=t.guid||s.guid||e.guid++,s):undefined})},listen:function(){this.$element.on("blur",e.proxy(this.blur,this)).on("keypress",e.proxy(this.keypress,this)).on("keyup",e.proxy(this.keyup,this)),(e.browser.webkit||e.browser.msie)&&this.$element.on("keydown",e.proxy(this.keypress,this)),this.$button&&this.$button.on("click",e.proxy(this.buttonLookup,this)),this.$menu.on("mouseenter","li",e.proxy(this.mouseenter,this))},keyup:function(e){switch(e.keyCode){case 40:case 38:break;case 9:if(!this.options.tabToSelect)break;case 13:if(this.onEnterFn){this.go();break}if(!this.shown)return;this.lookup(e);break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup(e)}e.stopPropagation(),e.preventDefault()},keypress:function(e){if(!this.shown)return;switch(e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 38:if(e.type!=="keydown")break;e.preventDefault(),this.prev();break;case 40:if(e.type!=="keydown")break;e.preventDefault(),this.next()}e.stopPropagation()},blur:function(e){var t=this;setTimeout(function(){t.hide()},150)},mouseenter:function(t){this.$menu.find(".active").removeClass("active"),e(t.currentTarget).addClass("active")}},e.fn.searchahead=function(n){return this.each(function(){var r=e(this),i=r.data("searchahead"),s=typeof n=="object"&&n;i||r.data("searchahead",i=new t(this,s)),typeof n=="string"&&i[n]()})},e.fn.searchahead.defaults={items:10,menu:'<ul class="typeahead dropdown-menu"></ul>'},e.fn.searchahead.Constructor=t}(window.$),$(function(){var e;$.fn.extend({timeago:function(t){var n=this,r,i,s,o,u;t=t||{};if(!t.date||!t.logger||!t.template||!t.lang)return;return i=t.date,s=t.logger,o=t.template,u=t.lang,r=function(){var e=$(this),t,n,r,s,a,f,l,c=new Date(e.attr("title")),h=i.getRelativeTimeLabel(c),p=e.data("label")?e.data("label"):"LBL_TIME_RELATIVE";return h.str&&(f=u.get(h.str),a=o.compile(h.str,f),r=i.format(c,"Y/m/d"),s=i.format(c,"H:i"),n={date:r,time:s,relativetime:a(h.value)},l=o.compile(p,u.get(p)),e.text(l(n))),this},n.each(r),n.length>0?(e?clearInterval(e):s.debug("(relative time) Starting a timer to convert "+n.length+" date"),e=setInterval(function(){n.each(r)},6e4)):e&&(s.debug("(relative time) Stopping the timer as there is no more date to convert"),clearInterval(e),e=undefined),n}})}),SUGAR=SUGAR||{},function(e){e.util=e.util||{};var t=e.util.ajaxCallInProgress;e.util.ajaxCallInProgress=function(){return t&&t()?!0:SUGAR.Api.getCallsInProgressCount()>0}}(SUGAR);