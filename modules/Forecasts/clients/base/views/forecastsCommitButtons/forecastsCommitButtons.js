/*********************************************************************************
 * By installing or using this file, you are confirming on behalf of the entity
 * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
 * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
 * http://www.sugarcrm.com/master-subscription-agreement
 *
 * If Company is not bound by the MSA, then by installing or using this file
 * you are agreeing unconditionally that Company will be bound by the MSA and
 * certifying that you have authority to bind Company accordingly.
 *
 * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
 ********************************************************************************/
({showCommitButton:true,commitButtonEnabled:false,showConfigButton:false,draft:0,events:{"click a[id=commit_forecast]":"triggerCommit","click a[id=save_draft]":"triggerSaveDraft","click a.drawerTrig":"triggerRightColumnVisibility","click a[id=export]":"triggerExport","click a[id=print]":"triggerPrint"},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.showConfigButton=(app.user.getAcls()['Forecasts'].admin=="yes");},unbindData:function(){if(this.context.forecasts.worksheet)this.context.forecasts.worksheet.off(null,null,this);if(this.context.forecasts.worksheetmanager)this.context.forecasts.worksheetmanager.off(null,null,this);if(this.context.forecasts)this.context.forecasts.off(null,null,this);app.view.View.prototype.unbindData.call(this);},bindDataChange:function(){var self=this;if(this.context&&this.context.forecasts){this.context.forecasts.on("change:selectedUser",function(context,user){var oldShowButtons=self.showCommitButton;self.showCommitButton=self.checkShowCommitButton(user.id);if(self.showCommitButton!=oldShowButtons){self._render();}});this.context.forecasts.on("change:reloadCommitButton",function(){self._render();},self);this.context.forecasts.on('forecasts:worksheet:dirty',function(model,changed){this.$el.find('#save_draft').removeClass("disabled");this.context.forecasts.trigger("forecasts:commitButtons:enabled");},self);this.context.forecasts.on("forecasts:commitButtons:triggerCommit",this.triggerCommit,self);this.context.forecasts.on("forecasts:commitButtons:triggerSaveDraft",this.triggerSaveDraft,self);this.context.forecasts.on("change:selectedUser",function(){this.context.forecasts.trigger("forecasts:commitButtons:disabled");},this);this.context.forecasts.on("change:selectedTimePeriod",function(){this.context.forecasts.trigger("forecasts:commitButtons:disabled");},this);this.context.forecasts.on("forecasts:commitButtons:enabled",this.enableCommitButton,this);this.context.forecasts.on("forecasts:commitButtons:disabled",this.disableCommitButton,this);}},_renderHtml:function(ctx,options){app.view.View.prototype._renderHtml.call(this,ctx,options);if(this.showCommitButton){if(this.commitButtonEnabled){this.$el.find('a[id=commit_forecast]').removeClass('disabled');}else{this.$el.find('a[id=commit_forecast]').addClass('disabled');}}},disableCommitButton:function(){var commitbtn=this.$el.find('#commit_forecast');var savebtn=this.$el.find('#save_draft');commitbtn.addClass("disabled");savebtn.addClass("disabled");this.commitButtonEnabled=true;},enableCommitButton:function(){var commitbtn=this.$el.find('#commit_forecast');commitbtn.removeClass("disabled");this.commitButtonEnabled=false;},triggerCommit:function(){var commitbtn=this.$el.find('#commit_forecast'),savebtn=this.$el.find('#save_draft');if(!commitbtn.hasClass("disabled")){var self=this;this.disableCommitButton();wkstCallBack=function(totalSaved,worksheet){self.context.forecasts.off('forecasts:worksheet:saved',wkstCallBack);self.context.forecasts.trigger('forecasts:committed:commit');};self.context.forecasts.on('forecasts:worksheet:saved',wkstCallBack);this.context.forecasts.trigger("forecasts:worksheet:saveWorksheet",false);}},triggerSaveDraft:function(){var savebtn=this.$el.find('#save_draft');if(!savebtn.hasClass("disabled")){this.context.forecasts.trigger("forecasts:worksheet:saveWorksheet",true);savebtn.addClass("disabled");this.enableCommitButton();}},checkShowCommitButton:function(id){return app.user.get('id')==id;},triggerRightColumnVisibility:function(evt){var el=$(evt.currentTarget);el.find('i').toggleClass('icon-chevron-right icon-chevron-left');el.parents('#contentflex').find('>div.row-fluid').find('>div:first').toggleClass('span8 span12');el.parents('#contentflex').find('>div.row-fluid').find('>div:last').toggleClass('span4 hide');this.context.forecasts.set({hiddenSidebar:el.find('i').hasClass('icon-chevron-left')});},triggerExport:function(evt){var savebtn=this.$el.find('#save_draft');var url='index.php?module=Forecasts&action=';url+=(this.context.forecasts.get("currentWorksheet")=='worksheetmanager')?'ExportManagerWorksheet':'ExportWorksheet';url+='&user_id='+this.context.forecasts.get('selectedUser').id;url+='&timeperiod_id='+$("#timeperiod").val();if(savebtn.length>0&&!savebtn.hasClass("disabled")){if(confirm(app.lang.get("LBL_WORKSHEET_EXPORT_CONFIRM","Forecasts"))){this.runExport(url);}}
else{this.runExport(url);}},runExport:function(url){var dlFrame=$("#forecastsDlFrame");if(dlFrame.length==0)
{dlFrame=$("<iframe>");dlFrame.attr("id","forecastsDlFrame");dlFrame.css("display","none");$("body").append(dlFrame);}
dlFrame.attr("src",url);},triggerPrint:function(evt){window.print();}})