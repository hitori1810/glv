/*********************************************************************************
 * By installing or using this file, you are confirming on behalf of the entity
 * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
 * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
 * http://www.sugarcrm.com/master-subscription-agreement
 *
 * If Company is not bound by the MSA, then by installing or using this file
 * you are agreeing unconditionally that Company will be bound by the MSA and
 * certifying that you have authority to bind Company accordingly.
 *
 * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
 ********************************************************************************/
({likelyTotal:0,bestTotal:0,shouldRollup:0,initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.model=new Backbone.Model({opportunities:0,revenue:0,closed_amount:0,closed_likely_amount:0,closed_likely_percent:0,closed_likely_above:0,quota_amount:0,quota_likely_amount:0,quota_likely_percent:0,quota_likely_above:0,closed_best_amount:0,closed_best_percent:0,closed_best_above:0,quota_best_amount:0,quota_best_percent:0,quota_best_above:0,closed_worst_amount:0,closed_worst_percent:0,closed_worst_above:0,quota_worst_amount:0,quota_worst_percent:0,quota_worst_above:0,show_likely:options.context.forecasts.config.get('show_worksheet_likely'),show_best:options.context.forecasts.config.get('show_worksheet_best'),show_worst:options.context.forecasts.config.get('show_worksheet_worst'),pipeline:0});this.selectedUser=this.context.forecasts.get("selectedUser");this.shouldRollup=this.isManagerView();this.selectedTimePeriod=this.context.forecasts.get("selectedTimePeriod");this.likelyTotal=0;this.bestTotal=0;this.worstTotal=0;this.updateProgress();},unbindData:function(){if(this.context.forecasts)this.context.forecasts.off(null,null,this);app.view.View.prototype.unbindData.call(this);},bindDataChange:function(){var self=this;if(this.model){this.model.on("change reset",this.render,this);}
if(this.context.forecasts){this.context.forecasts.on("change:selectedUser reset:selectedUser",function(context,selectedUser){this.updateProgressForSelectedUser(selectedUser);this.updateProgress();},this);this.context.forecasts.on("forecasts:committed:commit",function(context,flag){this.updateProgress();},this);this.context.forecasts.on("forecasts:worksheet:saved forecasts:committed:saved",function(){self.updateProgress();});this.context.forecasts.on("change:selectedTimePeriod reset:selectedTimePeriod",function(context,selectedTimePeriod){this.updateProgressForSelectedTimePeriod(selectedTimePeriod);this.updateProgress();},this);this.context.forecasts.on("change:updatedManagerTotals",function(context,totals){if(self.shouldRollup){self.recalculateManagerTotals(totals);}});this.context.forecasts.on("change:updatedTotals",function(context,totals){if(!self.shouldRollup){self.recalculateRepTotals(totals);}});}},recalculateRepTotals:function(totals){this.likelyTotal=totals.amount;this.bestTotal=totals.best_case;this.worstTotal=totals.worst_case;this.model.set({closed_amount:totals.won_amount,opportunities:totals.total_opp_count-totals.lost_count-totals.won_count,revenue:totals.overall_amount-totals.lost_amount-totals.won_amount});this.recalculateModel();},recalculateManagerTotals:function(totals){this.likelyTotal=totals.likely_adjusted;this.bestTotal=totals.best_adjusted;this.worstTotal=totals.worst_adjusted;this.recalculateModel();},recalculateModel:function(){this.model.set({closed_likely_amount:this.getAbsDifference(this.likelyTotal,this.model.get('closed_amount')),closed_likely_percent:this.getPercent(this.likelyTotal,this.model.get('closed_amount')),closed_likely_above:this.checkIsAbove(this.likelyTotal,this.model.get('closed_amount')),closed_best_amount:this.getAbsDifference(this.bestTotal,this.model.get('closed_amount')),closed_best_percent:this.getPercent(this.bestTotal,this.model.get('closed_amount')),closed_best_above:this.checkIsAbove(this.bestTotal,this.model.get('closed_amount')),closed_worst_amount:this.getAbsDifference(this.worstTotal,this.model.get('closed_amount')),closed_worst_percent:this.getPercent(this.worstTotal,this.model.get('closed_amount')),closed_worst_above:this.checkIsAbove(this.worstTotal,this.model.get('closed_amount')),quota_likely_amount:this.getAbsDifference(this.likelyTotal,this.model.get('quota_amount')),quota_likely_percent:this.getPercent(this.likelyTotal,this.model.get('quota_amount')),quota_likely_above:this.checkIsAbove(this.likelyTotal,this.model.get('quota_amount')),quota_best_amount:this.getAbsDifference(this.bestTotal,this.model.get('quota_amount')),quota_best_percent:this.getPercent(this.bestTotal,this.model.get('quota_amount')),quota_best_above:this.checkIsAbove(this.bestTotal,this.model.get('quota_amount')),quota_worst_amount:this.getAbsDifference(this.worstTotal,this.model.get('quota_amount')),quota_worst_percent:this.getPercent(this.worstTotal,this.model.get('quota_amount')),quota_worst_above:this.checkIsAbove(this.worstTotal,this.model.get('quota_amount')),pipeline:this.calculatePipelineSize(this.likelyTotal,this.model.get('revenue'))});},checkIsAbove:function(caseValue,stageValue){return caseValue>stageValue;},getAbsDifference:function(caseValue,stageValue){return Math.abs(stageValue-caseValue);},getPercent:function(caseValue,stageValue){return stageValue>0?caseValue / stageValue:0;},calculatePipelineSize:function(likelyTotal,revenue){var ps=0;if(likelyTotal>0){ps=revenue / likelyTotal;ps=Math.round(ps*10)/10;}
return ps;},isManagerView:function(){return this.selectedUser.isManager===true&&(this.selectedUser.showOpps==undefined||this.selectedUser.showOpps===false);},_renderHtml:function(ctx,options){_.extend(this,this.model.toJSON());app.view.View.prototype._renderHtml.call(this,ctx,options);},updateProgressForSelectedTimePeriod:function(selectedTimePeriod){this.selectedTimePeriod=selectedTimePeriod;},updateProgressForSelectedUser:function(selectedUser){this.selectedUser=selectedUser;this.shouldRollup=this.isManagerView();},updateProgress:function(){var self=this;var method=self.shouldRollup?"progressManager":"progressRep";var urlParams={user_id:self.selectedUser.id,timeperiod_id:self.selectedTimePeriod.id};var url=app.api.buildURL('Forecasts',method,'',urlParams);app.api.call('read',url,null,null,{success:function(data){if(self.shouldRollup){self.model.set({opportunities:data.opportunities,closed_amount:data.closed_amount,revenue:data.pipeline_revenue,quota_amount:data.quota_amount});}else{self.model.set({quota_amount:data.quota_amount});}
self.recalculateModel();}});}})